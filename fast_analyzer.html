<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNF Transaction Analyzer - Fast</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .upload-area {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px dashed #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }
        #fileInput {
            display: none;
        }
        .results {
            display: none;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .section {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .section-header {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-content {
            padding: 20px;
            display: none;
        }
        .section.expanded .section-content {
            display: block;
        }
        .pattern-section {
            border-left: 4px solid #805ad5;
        }
        .pattern-section .section-header {
            background: #805ad5;
        }
        .fraud-section {
            border-left: 4px solid #e53e3e;
        }
        .fraud-section .section-header {
            background: #e53e3e;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .alert {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .alert:hover {
            background: #fef5e7;
        }
        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .high-risk {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .medium-risk {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .low-risk {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .export-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .export-btn:hover {
            background: #218838;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 80%;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .progress-bar {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            margin: 10px 0;
        }
        .progress-fill {
            height: 20px;
            background-color: #007bff;
            border-radius: 10px;
            transition: width 0.3s;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SNF Transaction Analyzer - Optimized</h1>
            <p>Fast analysis for large transaction datasets</p>
        </div>

        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".csv">
            <h3>üìÅ Click here or drag & drop your CSV file</h3>
            <p>Optimized for large datasets (20,000+ transactions)</p>
        </div>

        <div class="loading">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing your transaction data...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
        </div>

        <div class="results">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalSpending">$0</div>
                    <div>Total Spending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div>Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFacilities">0</div>
                    <div>Facilities</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="potentialSavings" style="color: #28a745;">$0</div>
                    <div>Potential Savings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="riskScore" style="color: #dc3545;">0</div>
                    <div>Risk Score</div>
                </div>
            </div>

            <div class="section fraud-section expanded">
                <div class="section-header" onclick="toggleSection(this)">
                    üö® Quick Fraud Indicators
                    <span>‚ñº</span>
                </div>
                <div class="section-content" id="basicFraudSection"></div>
            </div>

            <div class="section pattern-section">
                <div class="section-header" onclick="toggleSection(this)">
                    üîç Advanced Pattern Analysis
                    <span>‚ñ∂</span>
                </div>
                <div class="section-content" id="patternSection"></div>
            </div>

            <div class="section expanded">
                <div class="section-header" onclick="toggleSection(this)">
                    üí∞ Cost-Saving Opportunities
                    <span>‚ñº</span>
                </div>
                <div class="section-content" id="savingsSection"></div>
            </div>

            <div class="section">
                <div class="section-header" onclick="toggleSection(this)">
                    üìä Top Spending Analysis
                    <span>‚ñ∂</span>
                </div>
                <div class="section-content">
                    <div style="margin-bottom: 20px;">
                        <h4>Top 15 Facilities by Spending</h4>
                        <table id="facilityTable">
                            <thead>
                                <tr><th>Facility</th><th>Total Spending</th><th>Transactions</th><th>Avg per Transaction</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div>
                        <h4>Master Contract Candidates</h4>
                        <table id="contractTable">
                            <thead>
                                <tr><th>Category</th><th>Total Spend</th><th>Transactions</th><th>Facilities</th><th>Potential Savings</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button class="export-btn" onclick="exportResults()">üìÑ Export Report</button>
            </div>
        </div>
    </div>

    <!-- Modal for detailed views -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">
                <h2 id="modalTitle">Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        let analysisResults = null;
        let transactions = [];

        // File handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
        });

        function handleFileSelect(e) {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }

            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.results').style.display = 'none';
            updateProgress(10, 'Reading file...');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                // Use setTimeout to allow UI to update
                setTimeout(() => processCSVFast(csv), 100);
            };
            reader.readAsText(file);
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressFill').textContent = percent + '%';
            document.getElementById('loadingText').textContent = text;
        }

        function processCSVFast(csvText) {
            try {
                updateProgress(20, 'Parsing CSV data...');
                
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                // Find column indices
                const netIndex = headers.findIndex(h => h.includes('NET'));
                const facilityIndex = headers.findIndex(h => h.includes('Facility'));
                const categoryIndex = headers.findIndex(h => h.includes('Account Description'));
                const dateIndex = headers.findIndex(h => h.includes('TRX Date'));
                
                if (netIndex === -1 || facilityIndex === -1 || categoryIndex === -1) {
                    throw new Error('Required columns not found in CSV');
                }

                updateProgress(40, 'Processing transactions...');
                transactions = [];
                
                // Process in chunks to avoid blocking
                const chunkSize = 1000;
                let processedLines = 0;
                
                const processChunk = () => {
                    const endIndex = Math.min(processedLines + chunkSize, lines.length);
                    
                    for (let i = processedLines === 0 ? 1 : processedLines; i < endIndex; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const columns = parseCSVLine(line);
                        if (columns.length < Math.max(netIndex, facilityIndex, categoryIndex, dateIndex) + 1) continue;
                        
                        const amount = parseFloat(columns[netIndex].replace(/[,$\s]/g, ''));
                        if (isNaN(amount) || amount <= 0) continue;
                        
                        transactions.push({
                            amount: amount,
                            facility: columns[facilityIndex].trim(),
                            category: columns[categoryIndex].trim(),
                            date: dateIndex >= 0 ? columns[dateIndex].trim() : '',
                            month: getMonthFromDate(dateIndex >= 0 ? columns[dateIndex].trim() : '')
                        });
                    }
                    
                    processedLines = endIndex;
                    const progress = 40 + (processedLines / lines.length) * 40;
                    updateProgress(Math.round(progress), `Processing ${processedLines}/${lines.length} rows...`);
                    
                    if (processedLines < lines.length) {
                        setTimeout(processChunk, 10); // Small delay to prevent blocking
                    } else {
                        if (transactions.length === 0) {
                            throw new Error('No valid transactions found');
                        }
                        setTimeout(analyzeDataFast, 100);
                    }
                };
                
                processChunk();
                
            } catch (error) {
                console.error('Error processing CSV:', error);
                alert('Error processing CSV: ' + error.message);
                document.querySelector('.loading').style.display = 'none';
            }
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function getMonthFromDate(dateStr) {
            if (!dateStr) return 'Unknown';
            try {
                const parts = dateStr.split('/');
                if (parts.length >= 2) {
                    const month = parseInt(parts[0]);
                    const year = parts.length >= 3 ? parts[2] : '2025';
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[month - 1]} ${year}`;
                }
            } catch (e) {}
            return dateStr;
        }

        function analyzeDataFast() {
            updateProgress(85, 'Running analysis...');
            
            const analysis = performBasicAnalysis();
            const patterns = performFastPatternAnalysis();
            
            analysisResults = { ...analysis, patterns };
            
            updateProgress(95, 'Updating dashboard...');
            setTimeout(() => {
                displayResults();
                document.querySelector('.loading').style.display = 'none';
                document.querySelector('.results').style.display = 'block';
                updateProgress(100, 'Complete!');
            }, 200);
        }

        function performBasicAnalysis() {
            const analysis = {
                totalSpending: 0,
                totalTransactions: transactions.length,
                facilities: new Set(),
                categories: {},
                facilityTotals: {},
                highValueTxns: [],
                roundAmounts: [],
                masterContractCandidates: []
            };

            // Quick pass through data
            const amounts = transactions.map(t => t.amount).sort((a, b) => b - a);
            const p99Threshold = amounts[Math.floor(amounts.length * 0.01)] || 500;

            transactions.forEach(txn => {
                analysis.totalSpending += txn.amount;
                analysis.facilities.add(txn.facility);

                // Facility analysis
                if (!analysis.facilityTotals[txn.facility]) {
                    analysis.facilityTotals[txn.facility] = { total: 0, count: 0 };
                }
                analysis.facilityTotals[txn.facility].total += txn.amount;
                analysis.facilityTotals[txn.facility].count += 1;

                // Category analysis
                if (!analysis.categories[txn.category]) {
                    analysis.categories[txn.category] = { 
                        total: 0, 
                        count: 0, 
                        facilities: new Set() 
                    };
                }
                analysis.categories[txn.category].total += txn.amount;
                analysis.categories[txn.category].count += 1;
                analysis.categories[txn.category].facilities.add(txn.facility);

                // High-value and round amounts (sample only for speed)
                if (Math.random() < 0.1) { // Sample 10% for display
                    if (txn.amount > p99Threshold) {
                        analysis.highValueTxns.push(txn);
                    }
                    if (txn.amount >= 50 && txn.amount % 50 === 0) {
                        analysis.roundAmounts.push(txn);
                    }
                }
            });

            // Master contract candidates
            Object.entries(analysis.categories).forEach(([category, data]) => {
                const facilityCount = data.facilities.size;
                if (data.count >= 10 && facilityCount >= 3 && data.total >= 500) {
                    analysis.masterContractCandidates.push({
                        category,
                        total: data.total,
                        count: data.count,
                        facilities: facilityCount,
                        savings: data.total * 0.15
                    });
                }
            });

            analysis.masterContractCandidates.sort((a, b) => b.total - a.total);
            analysis.highValueTxns.sort((a, b) => b.amount - a.amount);

            analysis.totalFacilities = analysis.facilities.size;
            analysis.potentialSavings = analysis.masterContractCandidates.reduce((sum, c) => sum + c.savings, 0);

            return analysis;
        }

        function performFastPatternAnalysis() {
            const patterns = {
                timingClusters: findTimingClusters(),
                duplicateAmounts: findDuplicateAmounts(),
                endOfMonthSpikes: findEndOfMonthSpikes(),
                suspiciousSequences: findSuspiciousSequences(),
                riskScore: 0
            };

            // Calculate risk score
            patterns.riskScore = Math.min(
                patterns.timingClusters.length * 2 +
                patterns.duplicateAmounts.length * 1 +
                patterns.endOfMonthSpikes.length * 3 +
                patterns.suspiciousSequences.length * 4,
                100
            );

            return patterns;
        }

        function findTimingClusters() {
            const dailyCounts = {};
            const clusters = [];

            // Count transactions per facility per day
            transactions.forEach(t => {
                const key = `${t.facility}_${t.date}`;
                dailyCounts[key] = (dailyCounts[key] || 0) + 1;
            });

            // Find high-count days
            Object.entries(dailyCounts).forEach(([key, count]) => {
                if (count > 8) {
                    const [facility, date] = key.split('_', 2);
                    clusters.push({
                        facility,
                        date,
                        count,
                        severity: count > 15 ? 'High' : 'Medium',
                        type: 'High Daily Volume'
                    });
                }
            });

            return clusters.sort((a, b) => b.count - a.count).slice(0, 20);
        }

        function findDuplicateAmounts() {
            const amountCounts = {};
            const duplicates = [];

            transactions.forEach(t => {
                const amount = t.amount.toFixed(2);
                amountCounts[amount] = (amountCounts[amount] || 0) + 1;
            });

            Object.entries(amountCounts).forEach(([amount, count]) => {
                if (count >= 8) {
                    duplicates.push({
                        amount: parseFloat(amount),
                        count,
                        severity: count > 15 ? 'High' : count > 10 ? 'Medium' : 'Low'
                    });
                }
            });

            return duplicates.sort((a, b) => b.count - a.count).slice(0, 15);
        }

        function findEndOfMonthSpikes() {
            const monthlyData = {};
            const spikes = [];

            transactions.forEach(t => {
                const date = new Date(t.date);
                if (isNaN(date.getTime())) return;

                const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                const dayOfMonth = date.getDate();

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, endMonth: 0 };
                }

                monthlyData[monthKey].total += t.amount;
                if (dayOfMonth >= 28) {
                    monthlyData[monthKey].endMonth += t.amount;
                }
            });

            Object.entries(monthlyData).forEach(([month, data]) => {
                const ratio = data.endMonth / data.total;
                if (ratio > 0.4 && data.total > 2000) {
                    spikes.push({
                        month,
                        percentage: (ratio * 100).toFixed(1),
                        totalSpending: data.total,
                        endSpending: data.endMonth,
                        severity: ratio > 0.6 ? 'High' : 'Medium'
                    });
                }
            });

            return spikes.sort((a, b) => parseFloat(b.percentage) - parseFloat(a.percentage));
        }

        function findSuspiciousSequences() {
            // Simple check for facilities with many round amounts
            const facilityRounds = {};
            const sequences = [];

            transactions.forEach(t => {
                if (t.amount % 50 === 0 && t.amount >= 100) {
                    facilityRounds[t.facility] = (facilityRounds[t.facility] || 0) + 1;
                }
            });

            Object.entries(facilityRounds).forEach(([facility, count]) => {
                if (count > 10) {
                    sequences.push({
                        facility,
                        roundCount: count,
                        severity: count > 20 ? 'High' : 'Medium',
                        type: 'High Round Amount Frequency'
                    });
                }
            });

            return sequences.sort((a, b) => b.roundCount - a.roundCount);
        }

        function displayResults() {
            // Update summary stats
            document.getElementById('totalSpending').textContent = formatCurrency(analysisResults.totalSpending);
            document.getElementById('totalTransactions').textContent = analysisResults.totalTransactions.toLocaleString();
            document.getElementById('totalFacilities').textContent = analysisResults.totalFacilities;
            document.getElementById('potentialSavings').textContent = formatCurrency(analysisResults.potentialSavings);
            document.getElementById('riskScore').textContent = analysisResults.patterns.riskScore;

            // Basic fraud indicators
            const basicFraudSection = document.getElementById('basicFraudSection');
            basicFraudSection.innerHTML = `
                <div class="alert danger" onclick="showHighValueTransactions()">
                    <strong>High-Value Transactions:</strong> ${analysisResults.highValueTxns.length * 10} estimated (click to view sample)
                </div>
                <div class="alert danger" onclick="showRoundAmounts()">
                    <strong>Round Amount Transactions:</strong> ${analysisResults.roundAmounts.length * 10} estimated (click to view sample)
                </div>
                <div class="alert">
                    <strong>Top Risk Facility:</strong> ${Object.entries(analysisResults.facilityTotals).sort((a,b) => b[1].total - a[1].total)[0][0]} 
                    with ${formatCurrency(Object.entries(analysisResults.facilityTotals).sort((a,b) => b[1].total - a[1].total)[0][1].total)}
                </div>
            `;

            // Pattern analysis
            updatePatternSection();

            // Cost savings
            updateSavingsSection();

            // Tables
            updateTables();
        }

        function updatePatternSection() {
            const patterns = analysisResults.patterns;
            const patternSection = document.getElementById('patternSection');
            
            const riskClass = patterns.riskScore > 30 ? 'high-risk' : patterns.riskScore > 15 ? 'medium-risk' : 'low-risk';
            
            let html = `
                <div class="alert ${riskClass}">
                    <strong>Overall Risk Score:</strong> ${patterns.riskScore}/100 
                    (${patterns.riskScore > 30 ? 'High' : patterns.riskScore > 15 ? 'Medium' : 'Low'} Risk)
                </div>
            `;

            if (patterns.timingClusters.length > 0) {
                html += `
                    <div class="alert medium-risk" onclick="showPatternDetail('timingClusters', 'Transaction Timing Clusters')">
                        <strong>üïê Timing Clusters:</strong> ${patterns.timingClusters.length} facilities with suspicious daily volumes (click for details)
                    </div>
                `;
            }

            if (patterns.duplicateAmounts.length > 0) {
                html += `
                    <div class="alert medium-risk" onclick="showPatternDetail('duplicateAmounts', 'Duplicate Amount Analysis')">
                        <strong>üîÑ Duplicate Amounts:</strong> ${patterns.duplicateAmounts.length} amounts appearing frequently (click for details)
                    </div>
                `;
            }

            if (patterns.endOfMonthSpikes.length > 0) {
                html += `
                    <div class="alert high-risk" onclick="showPatternDetail('endOfMonthSpikes', 'End-of-Month Spikes')">
                        <strong>üìÖ End-of-Month Spikes:</strong> ${patterns.endOfMonthSpikes.length} months with suspicious spending patterns (click for details)
                    </div>
                `;
            }

            if (patterns.suspiciousSequences.length > 0) {
                html += `
                    <div class="alert high-risk" onclick="showPatternDetail('suspiciousSequences', 'Suspicious Round Amount Patterns')">
                        <strong>üéØ Round Amount Patterns:</strong> ${patterns.suspiciousSequences.length} facilities with excessive round amounts (click for details)
                    </div>
                `;
            }

            patternSection.innerHTML = html;
        }

        function updateSavingsSection() {
            const savingsSection = document.getElementById('savingsSection');
            const topCandidate = analysisResults.masterContractCandidates[0];
            const savingsRate = (analysisResults.potentialSavings / analysisResults.totalSpending * 100).toFixed(1);
            
            savingsSection.innerHTML = `
                <div class="alert success">
                    <strong>Total Potential Savings:</strong> ${formatCurrency(analysisResults.potentialSavings)} (${savingsRate}% of total spending)
                </div>
                <div class="alert success">
                    <strong>Top Opportunity:</strong> ${topCandidate?.category || 'N/A'} - ${formatCurrency(topCandidate?.savings || 0)} potential savings
                </div>
                <div class="alert">
                    <strong>Master Contract Candidates:</strong> ${analysisResults.masterContractCandidates.length} categories identified
                </div>
            `;
        }

        function updateTables() {
            // Facility table
            const facilityTable = document.querySelector('#facilityTable tbody');
            facilityTable.innerHTML = '';
            Object.entries(analysisResults.facilityTotals)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 15)
                .forEach(([facility, data]) => {
                    const row = facilityTable.insertRow();
                    row.innerHTML = `
                        <td>Facility ${facility}</td>
                        <td>${formatCurrency(data.total)}</td>
                        <td>${data.count.toLocaleString()}</td>
                        <td>${formatCurrency(data.total / data.count)}</td>
                    `;
                });

            // Contract table
            const contractTable = document.querySelector('#contractTable tbody');
            contractTable.innerHTML = '';
            analysisResults.masterContractCandidates.slice(0, 15).forEach(candidate => {
                const row = contractTable.insertRow();
                row.innerHTML = `
                    <td>${candidate.category}</td>
                    <td>${formatCurrency(candidate.total)}</td>
                    <td>${candidate.count.toLocaleString()}</td>
                    <td>${candidate.facilities}</td>
                    <td style="color: #28a745; font-weight: bold">${formatCurrency(candidate.savings)}</td>
                `;
            });
        }

        function toggleSection(header) {
            const section = header.parentElement;
            const arrow = header.querySelector('span:last-child');
            
            section.classList.toggle('expanded');
            arrow.textContent = section.classList.contains('expanded') ? '‚ñº' : '‚ñ∂';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function showHighValueTransactions() {
            showModal('High-Value Transaction Sample', createTransactionTable(analysisResults.highValueTxns, 'Estimated total high-value transactions: ' + (analysisResults.highValueTxns.length * 10)));
        }

        function showRoundAmounts() {
            showModal('Round Amount Transaction Sample', createTransactionTable(analysisResults.roundAmounts, 'Estimated total round amount transactions: ' + (analysisResults.roundAmounts.length * 10)));
        }

        function showPatternDetail(patternType, title) {
            const patterns = analysisResults.patterns[patternType];
            let content = '';

            if (patternType === 'timingClusters') {
                content = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f7fafc;"><th style="padding: 12px; border: 1px solid #e2e8f0;">Facility</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Date</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Transaction Count</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Severity</th></tr></thead><tbody>';
                patterns.forEach(p => {
                    const color = p.severity === 'High' ? '#e53e3e' : '#d69e2e';
                    content += `<tr><td style="padding: 10px; border: 1px solid #e2e8f0;">Facility ${p.facility}</td><td style="padding: 10px; border: 1px solid #e2e8f0;">${p.date}</td><td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">${p.count}</td><td style="padding: 10px; border: 1px solid #e2e8f0; color: ${color}; font-weight: bold;">${p.severity}</td></tr>`;
                });
                content += '</tbody></table>';
            } else if (patternType === 'duplicateAmounts') {
                content = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f7fafc;"><th style="padding: 12px; border: 1px solid #e2e8f0;">Amount</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Occurrences</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Severity</th></tr></thead><tbody>';
                patterns.forEach(p => {
                    const color = p.severity === 'High' ? '#e53e3e' : p.severity === 'Medium' ? '#d69e2e' : '#38a169';
                    content += `<tr><td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">${formatCurrency(p.amount)}</td><td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">${p.count}</td><td style="padding: 10px; border: 1px solid #e2e8f0; color: ${color}; font-weight: bold;">${p.severity}</td></tr>`;
                });
                content += '</tbody></table>';
            } else if (patternType === 'endOfMonthSpikes') {
                content = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f7fafc;"><th style="padding: 12px; border: 1px solid #e2e8f0;">Month</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Total Spending</th><th style="padding: 12px; border: 1px solid #e2e8f0;">End-of-Month %</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Severity</th></tr></thead><tbody>';
                patterns.forEach(p => {
                    const color = p.severity === 'High' ? '#e53e3e' : '#d69e2e';
                    content += `<tr><td style="padding: 10px; border: 1px solid #e2e8f0;">${p.month}</td><td style="padding: 10px; border: 1px solid #e2e8f0;">${formatCurrency(p.totalSpending)}</td><td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">${p.percentage}%</td><td style="padding: 10px; border: 1px solid #e2e8f0; color: ${color}; font-weight: bold;">${p.severity}</td></tr>`;
                });
                content += '</tbody></table>';
            } else if (patternType === 'suspiciousSequences') {
                content = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f7fafc;"><th style="padding: 12px; border: 1px solid #e2e8f0;">Facility</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Round Amount Count</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Severity</th></tr></thead><tbody>';
                patterns.forEach(p => {
                    const color = p.severity === 'High' ? '#e53e3e' : '#d69e2e';
                    content += `<tr><td style="padding: 10px; border: 1px solid #e2e8f0;">Facility ${p.facility}</td><td style="padding: 10px; border: 1px solid #e2e8f0; font-weight: bold;">${p.roundCount}</td><td style="padding: 10px; border: 1px solid #e2e8f0; color: ${color}; font-weight: bold;">${p.severity}</td></tr>`;
                });
                content += '</tbody></table>';
            }

            showModal(title + ` (${patterns.length} found)`, content);
        }

        function createTransactionTable(txns, description) {
            let html = `<p style="margin-bottom: 20px; color: #666;">${description}</p>`;
            html += '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #f7fafc;"><th style="padding: 12px; border: 1px solid #e2e8f0;">Date</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Facility</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Amount</th><th style="padding: 12px; border: 1px solid #e2e8f0;">Category</th></tr></thead><tbody>';
            
            txns.forEach(txn => {
                html += `<tr><td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.date}</td><td style="padding: 10px; border: 1px solid #e2e8f0;">Facility ${txn.facility}</td><td style="padding: 10px; border: 1px solid #e2e8f0; color: #e53e3e; font-weight: bold;">${formatCurrency(txn.amount)}</td><td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.category}</td></tr>`;
            });
            
            html += '</tbody></table>';
            return html;
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('detailModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        function exportResults() {
            if (!analysisResults) return;

            const date = new Date().toLocaleDateString();
            let report = `SNF Transaction Analysis Report - ${date}\n${'='.repeat(50)}\n\n`;
            
            report += `EXECUTIVE SUMMARY\n`;
            report += `Total Spending: ${formatCurrency(analysisResults.totalSpending)}\n`;
            report += `Total Transactions: ${analysisResults.totalTransactions.toLocaleString()}\n`;
            report += `Facilities: ${analysisResults.totalFacilities}\n`;
            report += `Risk Score: ${analysisResults.patterns.riskScore}/100\n`;
            report += `Potential Savings: ${formatCurrency(analysisResults.potentialSavings)}\n\n`;

            report += `FRAUD RISK ANALYSIS\n`;
            report += `Timing Clusters: ${analysisResults.patterns.timingClusters.length}\n`;
            report += `Duplicate Amounts: ${analysisResults.patterns.duplicateAmounts.length}\n`;
            report += `End-of-Month Spikes: ${analysisResults.patterns.endOfMonthSpikes.length}\n`;
            report += `Round Amount Patterns: ${analysisResults.patterns.suspiciousSequences.length}\n\n`;

            report += `TOP COST-SAVING OPPORTUNITIES\n`;
            analysisResults.masterContractCandidates.slice(0, 10).forEach((c, i) => {
                report += `${i+1}. ${c.category}: ${formatCurrency(c.savings)} potential savings\n`;
            });

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SNF_Analysis_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>