<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNF Transaction Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        
        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #3182ce;
            color: white;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        .file-input-wrapper:hover {
            background: #2c5282;
        }
        
        .file-input-wrapper input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3182ce;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .card h3 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        
        .card .value {
            font-size: 2em;
            font-weight: bold;
            color: #e53e3e;
        }
        
        .savings .value {
            color: #38a169;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            margin-bottom: 20px;
            color: #2c5282;
            text-align: center;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .fraud-alerts {
            background: #fed7d7;
            border-left: 4px solid #e53e3e;
            margin-bottom: 30px;
        }
        
        .recommendations {
            background: #c6f6d5;
            border-left: 4px solid #38a169;
        }
        
        .alert-item, .rec-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .alert-item:last-child, .rec-item:last-child {
            border-bottom: none;
        }
        
        .alert-title, .rec-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .table-header {
            background: #3182ce;
            color: white;
            padding: 20px;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: bold;
            color: #2c5282;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .export-btn {
            background: #38a169;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s;
        }
        
        .export-btn:hover {
            background: #2f855a;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 80%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
        }
        
        .clickable {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .clickable:hover {
            background-color: rgba(49, 130, 206, 0.1);
        }
        
        .drill-down-section {
            margin-top: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .drill-down-header {
            background: #805ad5;
            color: white;
            padding: 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .filter-controls {
            background: #f7fafc;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .filter-group {
            display: inline-block;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c5282;
        }
        
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            background: white;
        }
        
        #drillDownTable {
            width: 100%;
        }
        
        #drillDownTable th {
            background: #edf2f7;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
            }
            
            .filter-group {
                display: block;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>SNF Transaction Analyzer</h1>
            <p>Upload your transaction CSV to identify cost-saving opportunities and fraud indicators</p>
        </div>
        
        <div class="upload-section">
            <div class="file-input-wrapper">
                <input type="file" id="csvFile" accept=".csv" />
                Upload CSV File
            </div>
            <div class="loading">
                <div class="spinner"></div>
                <p>Analyzing transactions...</p>
            </div>
        </div>
        
        <div class="results">
            <div class="summary-cards">
                <div class="card">
                    <h3>Total Spending</h3>
                    <div class="value" id="totalSpending">$0</div>
                </div>
                <div class="card">
                    <h3>Transactions</h3>
                    <div class="value" id="totalTransactions">0</div>
                </div>
                <div class="card">
                    <h3>Facilities</h3>
                    <div class="value" id="totalFacilities">0</div>
                </div>
                <div class="card savings">
                    <h3>Potential Savings</h3>
                    <div class="value" id="potentialSavings">$0</div>
                </div>
            </div>
            
            <div class="dashboard">
                <div class="chart-container">
                    <h3>Top 10 Facilities by Spending</h3>
                    <canvas id="facilitiesChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Top 10 Categories by Spending</h3>
                    <canvas id="categoriesChart"></canvas>
                </div>
                
                <div class="chart-container full-width">
                    <h3>Monthly Spending Trend</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            
            <div class="table-container fraud-alerts">
                <div class="table-header">🚨 Fraud Indicators (Click to View Details)</div>
                <div id="fraudAlerts"></div>
            </div>
            
            <div class="table-container recommendations">
                <div class="table-header">💰 Cost-Saving Opportunities</div>
                <div id="recommendations"></div>
            </div>
            
            <div class="table-container">
                <div class="table-header">📊 Master Contract Candidates</div>
                <table id="contractTable">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Total Spend</th>
                            <th>Transactions</th>
                            <th>Facilities</th>
                            <th>Potential Savings</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="table-container">
                <div class="table-header">⚠️ High-Value Transactions</div>
                <table id="highValueTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Facility</th>
                            <th>Amount</th>
                            <th>Category</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="drill-down-section">
                <div class="drill-down-header">
                    <span>📊 Detailed Spending Analysis</span>
                    <span style="font-size: 0.9em; font-weight: normal;">Category × Facility × Month Breakdown</span>
                </div>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="facilityFilter">Filter by Facility:</label>
                        <select id="facilityFilter">
                            <option value="all">All Facilities</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="categoryFilter">Filter by Category:</label>
                        <select id="categoryFilter">
                            <option value="all">All Categories</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="monthFilter">Filter by Month:</label>
                        <select id="monthFilter">
                            <option value="all">All Months</option>
                        </select>
                    </div>
                </div>
                <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                    <table id="drillDownTable">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Facility</th>
                                <th>Category</th>
                                <th>Total Spend</th>
                                <th>Transactions</th>
                                <th>Avg per Transaction</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="export-section">
                <button class="export-btn" onclick="exportReport('summary')">Export Summary</button>
                <button class="export-btn" onclick="exportReport('detailed')">Export Detailed Report</button>
            </div>
        </div>
    </div>

    <!-- Modal for detailed transaction views -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Transaction Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let analysisData = null;
        let rawTransactions = [];
        let drillDownData = [];
        
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                analyzeFile(file);
            }
        });
        
        function analyzeFile(file) {
            document.querySelector('.loading').style.display = 'block';
            document.querySelector('.results').style.display = 'none';
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    setTimeout(() => {
                        processData(results.data);
                        document.querySelector('.loading').style.display = 'none';
                        document.querySelector('.results').style.display = 'block';
                    }, 1000);
                }
            });
        }
        
        function processData(data) {
            // Clean and parse data
            const transactions = data.map(row => {
                const amount = parseFloat(row[' NET '] ? row[' NET '].replace(/,/g, '') : 0);
                const date = row['TRX Date'] || '';
                const month = date ? getMonthFromDate(date) : 'Unknown';
                
                return {
                    date: date,
                    month: month,
                    facility: row['Facility'],
                    category: row['Account Description'],
                    amount: amount,
                    vendor: row['Originating Master Name'],
                    reference: row['Reference'] || '',
                    document: row['Originating Document Number'] || ''
                };
            }).filter(t => t.amount > 0);
            
            rawTransactions = transactions;
            analysisData = analyzeTransactions(transactions);
            prepareDrillDownData(transactions);
            updateDashboard(analysisData);
        }
        
        function getMonthFromDate(dateStr) {
            // Handle various date formats
            if (!dateStr) return 'Unknown';
            
            try {
                // Assume format like "1/1/2025" or "01/01/2025"
                const parts = dateStr.split('/');
                if (parts.length >= 2) {
                    const month = parseInt(parts[0]);
                    const year = parts.length >= 3 ? parts[2] : '2025';
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                       'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${monthNames[month - 1]} ${year}`;
                }
            } catch (e) {
                console.warn('Date parsing error:', dateStr, e);
            }
            
            return dateStr;
        }
        
        function prepareDrillDownData(transactions) {
            const drillDown = {};
            
            transactions.forEach(t => {
                const key = `${t.month}_${t.facility}_${t.category}`;
                if (!drillDown[key]) {
                    drillDown[key] = {
                        month: t.month,
                        facility: t.facility,
                        category: t.category,
                        total: 0,
                        count: 0,
                        transactions: []
                    };
                }
                drillDown[key].total += t.amount;
                drillDown[key].count += 1;
                drillDown[key].transactions.push(t);
            });
            
            drillDownData = Object.values(drillDown)
                .map(item => ({
                    ...item,
                    avgPerTransaction: item.total / item.count
                }))
                .sort((a, b) => b.total - a.total);
            
            populateFilters();
            updateDrillDownTable();
        }
        
        function analyzeTransactions(transactions) {
            const analysis = {
                totalSpending: transactions.reduce((sum, t) => sum + t.amount, 0),
                totalTransactions: transactions.length,
                facilities: [...new Set(transactions.map(t => t.facility))],
                categories: {},
                facilityTotals: {},
                monthlySpending: {},
                highValueTxns: [],
                roundAmountTxns: [],
                masterContractCandidates: []
            };
            
            analysis.totalFacilities = analysis.facilities.length;
            
            // Process transactions
            transactions.forEach(t => {
                // Category analysis
                if (!analysis.categories[t.category]) {
                    analysis.categories[t.category] = {
                        total: 0,
                        count: 0,
                        facilities: new Set()
                    };
                }
                analysis.categories[t.category].total += t.amount;
                analysis.categories[t.category].count += 1;
                analysis.categories[t.category].facilities.add(t.facility);
                
                // Facility totals
                if (!analysis.facilityTotals[t.facility]) {
                    analysis.facilityTotals[t.facility] = { total: 0, count: 0 };
                }
                analysis.facilityTotals[t.facility].total += t.amount;
                analysis.facilityTotals[t.facility].count += 1;
                
                // Monthly spending
                const month = t.date ? t.date.substring(0, t.date.lastIndexOf('/')) : 'Unknown';
                if (!analysis.monthlySpending[month]) {
                    analysis.monthlySpending[month] = 0;
                }
                analysis.monthlySpending[month] += t.amount;
                
                // High value transactions (>99th percentile)
                const amounts = transactions.map(t => t.amount).sort((a, b) => b - a);
                const p99 = amounts[Math.floor(amounts.length * 0.01)];
                if (t.amount > p99) {
                    analysis.highValueTxns.push(t);
                }
                
                // Round amounts
                if (t.amount >= 50 && t.amount % 50 === 0) {
                    analysis.roundAmountTxns.push(t);
                }
            });
            
            // Master contract candidates
            Object.entries(analysis.categories).forEach(([category, data]) => {
                const facilityCount = data.facilities.size;
                if (data.count >= 20 && facilityCount >= 3 && data.total >= 500) {
                    analysis.masterContractCandidates.push({
                        category,
                        total: data.total,
                        count: data.count,
                        facilities: facilityCount,
                        savings: data.total * 0.15
                    });
                }
            });
            
            analysis.masterContractCandidates.sort((a, b) => b.total - a.total);
            analysis.highValueTxns.sort((a, b) => b.amount - a.amount);
            
            // Calculate total potential savings
            analysis.potentialSavings = analysis.masterContractCandidates.reduce((sum, c) => sum + c.savings, 0);
            
            return analysis;
        }
        
        function updateDashboard(data) {
            // Update summary cards
            document.getElementById('totalSpending').textContent = formatCurrency(data.totalSpending);
            document.getElementById('totalTransactions').textContent = data.totalTransactions.toLocaleString();
            document.getElementById('totalFacilities').textContent = data.totalFacilities;
            document.getElementById('potentialSavings').textContent = formatCurrency(data.potentialSavings);
            
            // Create charts
            createFacilitiesChart(data.facilityTotals);
            createCategoriesChart(data.categories);
            createTrendChart(data.monthlySpending);
            
            // Update tables
            updateContractTable(data.masterContractCandidates);
            updateHighValueTable(data.highValueTxns);
            updateFraudAlerts(data);
            updateRecommendations(data);
        }
        
        function createFacilitiesChart(facilityTotals) {
            const sortedFacilities = Object.entries(facilityTotals)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const ctx = document.getElementById('facilitiesChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedFacilities.map(f => `Facility ${f[0]}`),
                    datasets: [{
                        label: 'Spending',
                        data: sortedFacilities.map(f => f[1].total),
                        backgroundColor: '#3182ce',
                        borderColor: '#2c5282',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function createCategoriesChart(categories) {
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCategories.map(c => c[0].substring(0, 20) + (c[0].length > 20 ? '...' : '')),
                    datasets: [{
                        data: sortedCategories.map(c => c[1].total),
                        backgroundColor: [
                            '#3182ce', '#e53e3e', '#38a169', '#d69e2e', '#805ad5',
                            '#dd6b20', '#319795', '#c53030', '#2b6cb0', '#2c5282'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function createTrendChart(monthlySpending) {
            const sortedMonths = Object.entries(monthlySpending)
                .sort((a, b) => new Date(a[0] + '/2025') - new Date(b[0] + '/2025'));
            
            const ctx = document.getElementById('trendChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths.map(m => m[0]),
                    datasets: [{
                        label: 'Monthly Spending',
                        data: sortedMonths.map(m => m[1]),
                        borderColor: '#3182ce',
                        backgroundColor: 'rgba(49, 130, 206, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function updateContractTable(candidates) {
            const tbody = document.querySelector('#contractTable tbody');
            tbody.innerHTML = '';
            
            candidates.slice(0, 15).forEach(candidate => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${candidate.category}</td>
                    <td>${formatCurrency(candidate.total)}</td>
                    <td>${candidate.count.toLocaleString()}</td>
                    <td>${candidate.facilities}</td>
                    <td style="color: #38a169; font-weight: bold">${formatCurrency(candidate.savings)}</td>
                `;
            });
        }
        
        function updateHighValueTable(highValueTxns) {
            const tbody = document.querySelector('#highValueTable tbody');
            tbody.innerHTML = '';
            
            highValueTxns.slice(0, 20).forEach(txn => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${txn.date}</td>
                    <td>${txn.facility}</td>
                    <td style="color: #e53e3e; font-weight: bold">${formatCurrency(txn.amount)}</td>
                    <td>${txn.category}</td>
                `;
            });
        }
        
        function updateFraudAlerts(data) {
            const container = document.getElementById('fraudAlerts');
            container.innerHTML = `
                <div class="alert-item clickable" onclick="showHighValueTransactions()">
                    <div class="alert-title">🔍 High-Value Transactions (Click to View)</div>
                    <div>Found ${data.highValueTxns.length} transactions requiring review (>99th percentile)</div>
                </div>
                <div class="alert-item clickable" onclick="showRoundAmountTransactions()">
                    <div class="alert-title">🔍 Suspicious Round Amounts (Click to View)</div>
                    <div>Found ${data.roundAmountTxns.length} transactions with round amounts ≥$50</div>
                </div>
                <div class="alert-item">
                    <div class="alert-title">Top Risk Facility</div>
                    <div>Facility ${Object.entries(data.facilityTotals).sort((a,b) => b[1].total - a[1].total)[0][0]} 
                         - ${formatCurrency(Object.entries(data.facilityTotals).sort((a,b) => b[1].total - a[1].total)[0][1].total)} total spending</div>
                </div>
            `;
        }
        
        function updateRecommendations(data) {
            const container = document.getElementById('recommendations');
            const topCategory = data.masterContractCandidates[0];
            const savingsRate = (data.potentialSavings / data.totalSpending) * 100;
            
            container.innerHTML = `
                <div class="rec-item">
                    <div class="rec-title">Master Contract Priority</div>
                    <div>Focus on "${topCategory?.category}" - ${formatCurrency(topCategory?.savings)} potential savings</div>
                </div>
                <div class="rec-item">
                    <div class="rec-title">Overall Savings Potential</div>
                    <div>${formatCurrency(data.potentialSavings)} total savings (${savingsRate.toFixed(1)}% of Amazon spend)</div>
                </div>
                <div class="rec-item">
                    <div class="rec-title">Procurement Training</div>
                    <div>Target top ${Math.min(5, data.totalFacilities)} facilities for emergency purchase reduction training</div>
                </div>
            `;
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }
        
        function exportReport(type) {
            if (!analysisData) return;
            
            let content = '';
            const date = new Date().toLocaleDateString();
            
            if (type === 'summary') {
                content = `SNF Transaction Analysis Summary - ${date}\n\n`;
                content += `Total Spending: ${formatCurrency(analysisData.totalSpending)}\n`;
                content += `Total Transactions: ${analysisData.totalTransactions.toLocaleString()}\n`;
                content += `Facilities: ${analysisData.totalFacilities}\n`;
                content += `Potential Savings: ${formatCurrency(analysisData.potentialSavings)}\n\n`;
                content += `Top Master Contract Opportunities:\n`;
                analysisData.masterContractCandidates.slice(0, 10).forEach((c, i) => {
                    content += `${i+1}. ${c.category} - ${formatCurrency(c.savings)} potential savings\n`;
                });
            } else {
                content = `Detailed SNF Transaction Analysis - ${date}\n\n`;
                content += `EXECUTIVE SUMMARY\n`;
                content += `Total Amazon Spending: ${formatCurrency(analysisData.totalSpending)}\n`;
                content += `Total Transactions: ${analysisData.totalTransactions.toLocaleString()}\n`;
                content += `Facilities: ${analysisData.totalFacilities}\n`;
                content += `Potential Savings: ${formatCurrency(analysisData.potentialSavings)}\n\n`;
                
                content += `FRAUD INDICATORS\n`;
                content += `High-Value Transactions: ${analysisData.highValueTxns.length}\n`;
                content += `Round Amount Transactions: ${analysisData.roundAmountTxns.length}\n\n`;
                
                content += `MASTER CONTRACT CANDIDATES\n`;
                analysisData.masterContractCandidates.forEach((c, i) => {
                    content += `${i+1}. ${c.category}\n`;
                    content += `   Total: ${formatCurrency(c.total)}\n`;
                    content += `   Transactions: ${c.count}\n`;
                    content += `   Facilities: ${c.facilities}\n`;
                    content += `   Potential Savings: ${formatCurrency(c.savings)}\n\n`;
                });
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SNF_Analysis_${type}_${date.replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Modal and fraud detail functions
        function showHighValueTransactions() {
            const highValueTxns = analysisData.highValueTxns;
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `High-Value Transactions (${highValueTxns.length} found)`;
            
            let tableHTML = `
                <p style="margin-bottom: 20px; color: #666;">Transactions above the 99th percentile that may require additional oversight:</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc;">
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Date</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Facility</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Amount</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Category</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Document</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            highValueTxns.forEach(txn => {
                tableHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.date}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.facility}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; color: #e53e3e; font-weight: bold;">${formatCurrency(txn.amount)}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.category}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-family: monospace;">${txn.document || txn.reference || 'N/A'}</td>
                    </tr>`;
            });
            
            tableHTML += '</tbody></table>';
            modalBody.innerHTML = tableHTML;
            document.getElementById('transactionModal').style.display = 'block';
        }
        
        function showRoundAmountTransactions() {
            const roundTxns = analysisData.roundAmountTxns;
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = `Suspicious Round-Amount Transactions (${roundTxns.length} found)`;
            
            let tableHTML = `
                <p style="margin-bottom: 20px; color: #666;">Transactions with round amounts (multiples of $50) that may indicate manual entry or potential fraud:</p>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f7fafc;">
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Date</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Facility</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Amount</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Category</th>
                            <th style="padding: 12px; border: 1px solid #e2e8f0;">Document</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            roundTxns.forEach(txn => {
                tableHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.date}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.facility}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; color: #e53e3e; font-weight: bold;">${formatCurrency(txn.amount)}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0;">${txn.category}</td>
                        <td style="padding: 10px; border: 1px solid #e2e8f0; font-family: monospace;">${txn.document || txn.reference || 'N/A'}</td>
                    </tr>`;
            });
            
            tableHTML += '</tbody></table>';
            modalBody.innerHTML = tableHTML;
            document.getElementById('transactionModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('transactionModal').style.display = 'none';
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('transactionModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        function populateFilters() {
            const facilities = [...new Set(drillDownData.map(d => d.facility))].sort();
            const categories = [...new Set(drillDownData.map(d => d.category))].sort();
            const months = [...new Set(drillDownData.map(d => d.month))].sort();
            
            const facilityFilter = document.getElementById('facilityFilter');
            const categoryFilter = document.getElementById('categoryFilter');
            const monthFilter = document.getElementById('monthFilter');
            
            // Clear existing options except "All"
            facilityFilter.innerHTML = '<option value="all">All Facilities</option>';
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            monthFilter.innerHTML = '<option value="all">All Months</option>';
            
            facilities.forEach(facility => {
                facilityFilter.innerHTML += `<option value="${facility}">Facility ${facility}</option>`;
            });
            
            categories.forEach(category => {
                categoryFilter.innerHTML += `<option value="${category}">${category}</option>`;
            });
            
            months.forEach(month => {
                monthFilter.innerHTML += `<option value="${month}">${month}</option>`;
            });
            
            // Add event listeners
            facilityFilter.addEventListener('change', updateDrillDownTable);
            categoryFilter.addEventListener('change', updateDrillDownTable);
            monthFilter.addEventListener('change', updateDrillDownTable);
        }
        
        function updateDrillDownTable() {
            const facilityFilter = document.getElementById('facilityFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            let filteredData = drillDownData;
            
            if (facilityFilter !== 'all') {
                filteredData = filteredData.filter(d => d.facility === facilityFilter);
            }
            if (categoryFilter !== 'all') {
                filteredData = filteredData.filter(d => d.category === categoryFilter);
            }
            if (monthFilter !== 'all') {
                filteredData = filteredData.filter(d => d.month === monthFilter);
            }
            
            const tbody = document.querySelector('#drillDownTable tbody');
            tbody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.month}</td>
                    <td>Facility ${item.facility}</td>
                    <td>${item.category}</td>
                    <td>${formatCurrency(item.total)}</td>
                    <td>${item.count}</td>
                    <td>${formatCurrency(item.avgPerTransaction)}</td>
                `;
            });
            
            // Show summary of filtered results
            const totalFiltered = filteredData.reduce((sum, item) => sum + item.total, 0);
            const countFiltered = filteredData.reduce((sum, item) => sum + item.count, 0);
            
            document.querySelector('.drill-down-header span:last-child').textContent = 
                `Showing ${filteredData.length} combinations • ${formatCurrency(totalFiltered)} • ${countFiltered} transactions`;
        }
    </script>
</body>
</html>