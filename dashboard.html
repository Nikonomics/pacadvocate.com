<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNF Legislation Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .relevance-very-high { background-color: #dc2626; color: white; }
        .relevance-high { background-color: #ea580c; color: white; }
        .relevance-medium { background-color: #ca8a04; color: white; }
        .relevance-low { background-color: #16a34a; color: white; }
        .relevance-very-low { background-color: #6b7280; color: white; }

        .expanded-row { background-color: #f8fafc; }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .alert-notification {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .chart-container { position: relative; height: 300px; }

        .status-passed {
            background-color: #10b981;
            color: white;
            position: relative;
        }
        .status-passed::before {
            content: "‚úì";
            margin-right: 4px;
        }

        .status-pending {
            background-color: #f59e0b;
            color: white;
            position: relative;
        }
        .status-pending::before {
            content: "‚è±";
            margin-right: 4px;
        }

        .status-proposed {
            background-color: #6b7280;
            color: white;
        }

        .status-final {
            background-color: #059669;
            color: white;
        }
        .status-final::before {
            content: "üìã";
            margin-right: 4px;
        }

        .deadline-urgent {
            color: #dc2626 !important;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .snf-impact-highlight {
            background-color: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 4px;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-none {
            display: block;
            -webkit-line-clamp: unset;
        }

        /* Risk Score Styling */
        .risk-score-critical { background-color: #dc2626; color: white; }
        .risk-score-high { background-color: #ea580c; color: white; }
        .risk-score-moderate { background-color: #ca8a04; color: white; }
        .risk-score-low { background-color: #16a34a; color: white; }
        .risk-score-minimal { background-color: #6b7280; color: white; }

        /* Risk Badge Styling */
        .risk-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 2px;
            font-size: 10px;
            text-align: center;
        }

        .risk-badge.reimbursement { background-color: #dc2626; }
        .risk-badge.reimbursement.light { background-color: #fca5a5; color: #7f1d1d; }
        .risk-badge.reimbursement.medium { background-color: #ef4444; }
        .risk-badge.reimbursement.dark { background-color: #991b1b; }

        .risk-badge.staffing { background-color: #ea580c; }
        .risk-badge.staffing.light { background-color: #fed7aa; color: #9a3412; }
        .risk-badge.staffing.medium { background-color: #f97316; }
        .risk-badge.staffing.dark { background-color: #c2410c; }

        .risk-badge.compliance { background-color: #ca8a04; }
        .risk-badge.compliance.light { background-color: #fde68a; color: #92400e; }
        .risk-badge.compliance.medium { background-color: #eab308; }
        .risk-badge.compliance.dark { background-color: #a16207; }

        .risk-badge.quality { background-color: #7c3aed; }
        .risk-badge.quality.light { background-color: #c4b5fd; color: #5b21b6; }
        .risk-badge.quality.medium { background-color: #8b5cf6; }
        .risk-badge.quality.dark { background-color: #6d28d9; }

        /* Tooltip Styling */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            pointer-events: none;
        }

        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .tooltip.breakdown {
            max-width: 300px;
            white-space: normal;
            text-align: center;
            line-height: 1.4;
        }

        .tooltip.concern {
            max-width: 250px;
            white-space: normal;
            text-align: left;
            line-height: 1.3;
        }

        /* Risk-specific tooltip colors */
        .tooltip.reimbursement { background-color: rgba(220, 38, 38, 0.95); }
        .tooltip.staffing { background-color: rgba(234, 88, 12, 0.95); }
        .tooltip.compliance { background-color: rgba(202, 138, 4, 0.95); }
        .tooltip.quality { background-color: rgba(124, 58, 237, 0.95); }

        .tooltip.reimbursement::after { border-color: rgba(220, 38, 38, 0.95) transparent transparent transparent; }
        .tooltip.staffing::after { border-color: rgba(234, 88, 12, 0.95) transparent transparent transparent; }
        .tooltip.compliance::after { border-color: rgba(202, 138, 4, 0.95) transparent transparent transparent; }
        .tooltip.quality::after { border-color: rgba(124, 58, 237, 0.95) transparent transparent transparent; }

        .bill-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .bill-row:hover {
            background-color: #f8fafc;
        }

        .expanded-summary {
            max-width: none;
            word-wrap: break-word;
            white-space: normal;
        }

        .view-original-btn {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .view-original-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-gavel text-2xl"></i>
                    <h1 class="text-2xl font-bold">SNF Legislation Tracker</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="connectionStatus" class="flex items-center space-x-2">
                        <div class="w-3 h-3 bg-red-500 rounded-full" id="statusIndicator"></div>
                        <span class="text-sm">Disconnected</span>
                    </div>
                    <div id="userInfo" class="hidden flex items-center space-x-2">
                        <i class="fas fa-user"></i>
                        <span id="userName"></span>
                    </div>
                    <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 px-4 py-2 rounded text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-8 w-full max-w-md mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-4xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">Login Required</h2>
                <p class="text-gray-600 mt-2">Please login to access the dashboard</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                    <input type="email" id="loginEmail" value="demo@example.com"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="loginPassword" value="demo123"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">
                    <i class="fas fa-sign-in-alt mr-2"></i>Login
                </button>
            </form>
            <div id="loginError" class="hidden mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6" id="mainContent">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 mr-4">
                        <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Total Bills</p>
                        <p class="text-2xl font-semibold" id="totalBills">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 mr-4">
                        <i class="fas fa-star text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">High Relevance</p>
                        <p class="text-2xl font-semibold" id="highRelevanceBills">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 mr-4">
                        <i class="fas fa-bell text-yellow-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Unread Alerts</p>
                        <p class="text-2xl font-semibold" id="unreadAlerts">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100 mr-4">
                        <i class="fas fa-chart-line text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <p class="text-gray-600 text-sm">Tracked Bills</p>
                        <p class="text-2xl font-semibold" id="trackedBills">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Bills by State</h3>
                <div class="chart-container">
                    <canvas id="billsByStateChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Activity Timeline</h3>
                <div class="chart-container">
                    <canvas id="activityTimelineChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">
                <i class="fas fa-filter mr-2"></i>Filters
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Jurisdiction</label>
                    <select id="jurisdictionFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                        <option value="">All</option>
                        <option value="federal">Federal</option>
                        <option value="state">State</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Industry</label>
                    <select id="industryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                        <option value="">All</option>
                        <option value="SNF">SNF</option>
                        <option value="ALF">ALF</option>
                        <option value="HH">Home Health</option>
                        <option value="HOS">Hospice</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Multi">Multiple Tags</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Min Relevance</label>
                    <input type="number" id="relevanceFilter" min="0" max="100" placeholder="0-100"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Keywords</label>
                    <input type="text" id="keywordFilter" placeholder="Search keywords..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:border-blue-500">
                </div>
                <div class="flex items-end">
                    <button id="applyFilters" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md mr-2">
                        <i class="fas fa-search mr-1"></i>Apply
                    </button>
                </div>
                <div class="flex items-end">
                    <button id="clearFilters" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md">
                        <i class="fas fa-times mr-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Bills Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold">
                    <i class="fas fa-table mr-2"></i>Tracked Bills
                    <span id="billsCount" class="text-sm text-gray-500 ml-2">(0)</span>
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="bill_number">
                                Bill # <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="title">
                                Title <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="relevance_score">
                                Relevance <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="total_risk_score">
                                Risk Score <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="status">
                                Status <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" data-sort="state_or_federal">
                                Jurisdiction <i class="fas fa-sort ml-1"></i>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Industry
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="billsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Bills will be loaded here -->
                    </tbody>
                </table>
                <div id="loadingIndicator" class="text-center py-8">
                    <i class="fas fa-spinner loading-spinner text-2xl text-blue-600"></i>
                    <p class="mt-2 text-gray-600">Loading bills...</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-700">
                Showing <span id="showingStart">1</span> to <span id="showingEnd">20</span> of <span id="totalResults">0</span> results
            </div>
            <div class="flex space-x-1">
                <button id="prevPage" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 rounded-md hover:bg-gray-50 disabled:opacity-50" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div id="pageNumbers" class="flex space-x-1">
                    <!-- Page numbers will be generated here -->
                </div>
                <button id="nextPage" class="px-3 py-2 text-sm bg-white border border-gray-300 text-gray-500 rounded-md hover:bg-gray-50 disabled:opacity-50">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Alert Notifications -->
    <div id="alertContainer" class="fixed top-4 right-4 z-40 space-y-2">
        <!-- Real-time alerts will appear here -->
    </div>

    <script>
        // Global variables
        let accessToken = null;
        let currentPage = 1;
        let totalPages = 1;
        let currentSort = { field: null, order: 'asc' };
        let bills = [];
        let websocket = null;

        // Initialize chart variables
        window.billsByStateChart = null;
        window.activityTimelineChart = null;

        // API Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const API_PREFIX = '/api/v1';

        // Clean up charts when page unloads
        function cleanupCharts() {
            if (window.billsByStateChart && window.billsByStateChart instanceof Chart) {
                window.billsByStateChart.destroy();
                window.billsByStateChart = null;
            }
            if (window.activityTimelineChart && window.activityTimelineChart instanceof Chart) {
                window.activityTimelineChart.destroy();
                window.activityTimelineChart = null;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', cleanupCharts);

        function initializeApp() {
            // Load dashboard without authentication (bills endpoint is public)
            console.log('üöÄ Loading SNF Legislation Tracker Dashboard');
            showMainContent();
            loadDashboardData();
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Filter controls
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // Sorting
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => handleSort(th.dataset.sort));
            });

            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => changePage(currentPage - 1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(currentPage + 1));

            // Filter inputs - apply on Enter key
            document.getElementById('keywordFilter').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') applyFilters();
            });
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', data.refresh_token);

                    hideLoginModal();
                    showMainContent();
                    loadDashboard();
                    showNotification('Login successful!', 'success');
                } else {
                    const error = await response.json();
                    showLoginError(error.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showLoginError('Connection error. Please try again.');
            }
        }

        function handleLogout() {
            accessToken = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');

            // Disconnect WebSocket
            if (websocket) {
                websocket.close();
                websocket = null;
            }

            showLoginModal();
            hideMainContent();
            updateConnectionStatus(false);
            showNotification('Logged out successfully', 'info');
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
        }

        function hideMainContent() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
        }

        function showLoginError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        async function loadDashboard() {
            updateConnectionStatus(true);

            try {
                // Load user profile
                await loadUserProfile();

                // Load dashboard data
                await Promise.all([
                    loadDashboardStats(),
                    loadBills(),
                    loadChartData()
                ]);

                // Setup WebSocket for real-time alerts
                setupWebSocket();

            } catch (error) {
                console.error('Dashboard loading error:', error);
                if (error.status === 401) {
                    handleLogout();
                }
            }
        }

        async function loadDashboardData() {
            updateConnectionStatus(true);
            console.log('üìä Loading dashboard with real API data...');

            // Hide user info since no authentication
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');

            try {
                // Load real data from API
                await Promise.all([
                    loadRealBills(),
                    loadRealStats()
                ]);

                showNotification('Dashboard loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Error loading dashboard data. Using fallback.', 'error');
                // Fallback to basic display
                loadBasicStats();
            }
        }

        async function loadUserProfile() {
            try {
                const response = await apiRequest('/auth/me');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('userName').textContent = user.full_name || user.email;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        async function loadDashboardStats() {
            try {
                const response = await apiRequest('/dashboard/stats');
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsCards(stats);
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        function updateStatsCards(stats) {
            document.getElementById('totalBills').textContent = stats.bill_stats?.total_bills || 0;
            document.getElementById('highRelevanceBills').textContent = stats.bill_stats?.high_relevance_bills || 0;
            document.getElementById('unreadAlerts').textContent = stats.alert_stats?.unread_alerts || 0;
            document.getElementById('trackedBills').textContent = stats.user_activity?.tracked_bills || 0;
        }

        // Mock data functions for testing
        function loadMockStats() {
            const mockStats = {
                bill_stats: {
                    total_bills: 1247,
                    high_relevance_bills: 89,
                    bills_by_state: {
                        'federal': 856,
                        'state': 391
                    }
                },
                alert_stats: {
                    unread_alerts: 12
                },
                user_activity: {
                    tracked_bills: 23
                }
            };
            updateStatsCards(mockStats);
        }

        function loadMockBills() {
            const mockBills = [
                {
                    id: 1,
                    bill_number: 'H.R. 2025',
                    title: 'Medicare SNF Payment Enhancement Act',
                    relevance_score: 92.5,
                    status: 'Introduced in House',
                    state_or_federal: 'federal',
                    sponsor: 'Rep. Healthcare Advocate',
                    chamber: 'House',
                    summary: 'This bill would enhance Medicare payments to skilled nursing facilities to improve quality of care and financial stability.',
                    updated_at: '2024-01-15T10:30:00Z'
                },
                {
                    id: 2,
                    bill_number: 'S. 1234',
                    title: 'Nursing Home Staffing Standards Act',
                    relevance_score: 87.3,
                    status: 'Committee Review',
                    state_or_federal: 'federal',
                    sponsor: 'Sen. Quality Care',
                    chamber: 'Senate',
                    summary: 'Establishes minimum staffing requirements for nursing homes to ensure adequate patient care.',
                    updated_at: '2024-01-14T14:20:00Z'
                },
                {
                    id: 3,
                    bill_number: 'H.R. 3456',
                    title: 'Long-Term Care Transparency Act',
                    relevance_score: 76.8,
                    status: 'Passed House',
                    state_or_federal: 'federal',
                    sponsor: 'Rep. Transparency First',
                    chamber: 'House',
                    summary: 'Requires enhanced reporting and transparency measures for long-term care facilities.',
                    updated_at: '2024-01-13T09:15:00Z'
                },
                {
                    id: 4,
                    bill_number: 'CA SB 567',
                    title: 'California SNF Quality Improvement',
                    relevance_score: 65.2,
                    status: 'State Legislature',
                    state_or_federal: 'state',
                    sponsor: 'Sen. State Quality',
                    chamber: 'State Senate',
                    summary: 'State-level quality improvement initiatives for skilled nursing facilities in California.',
                    updated_at: '2024-01-12T16:45:00Z'
                },
                {
                    id: 5,
                    bill_number: 'H.R. 7890',
                    title: 'Rural Healthcare Access Enhancement',
                    relevance_score: 58.9,
                    status: 'Subcommittee',
                    state_or_federal: 'federal',
                    sponsor: 'Rep. Rural Advocate',
                    chamber: 'House',
                    summary: 'Improves healthcare access in rural areas, including support for skilled nursing facilities.',
                    updated_at: '2024-01-11T11:30:00Z'
                }
            ];

            bills = mockBills;
            displayBills(mockBills);
            updateBillsCount(mockBills.length);

            // Mock pagination
            totalPages = 1;
            currentPage = 1;
            updateMockPagination(mockBills.length);
        }

        function updateMockPagination(total) {
            document.getElementById('showingStart').textContent = 1;
            document.getElementById('showingEnd').textContent = total;
            document.getElementById('totalResults').textContent = total;

            document.getElementById('prevPage').disabled = true;
            document.getElementById('nextPage').disabled = true;

            const pageNumbersDiv = document.getElementById('pageNumbers');
            pageNumbersDiv.innerHTML = '<button class="px-3 py-2 text-sm bg-blue-600 text-white border-blue-600 rounded-md">1</button>';

            showLoadingIndicator(false);
        }

        async function loadRealStats() {
            try {
                // Get first page of all bills to calculate stats
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/bills/?page=1&page_size=100`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    const allBills = data.bills || [];
                    const totalBills = data.total || 0;

                    // Calculate statistics from real data
                    const highRelevanceBills = allBills.filter(bill =>
                        bill.relevance_score && bill.relevance_score >= 70
                    ).length;

                    const stats = {
                        bill_stats: {
                            total_bills: totalBills,
                            high_relevance_bills: highRelevanceBills
                        },
                        alert_stats: {
                            unread_alerts: 0 // No auth, so no alerts
                        },
                        user_activity: {
                            tracked_bills: 0 // No auth, so no tracked bills
                        }
                    };

                    updateStatsCards(stats);
                    console.log(`üìä Stats updated: ${totalBills} total bills, ${highRelevanceBills} high relevance`);
                } else {
                    throw new Error(`Stats API request failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                loadBasicStats();
            }
        }

        function loadBasicStats() {
            // Fallback stats when API is unavailable
            const stats = {
                bill_stats: { total_bills: 0, high_relevance_bills: 0 },
                alert_stats: { unread_alerts: 0 },
                user_activity: { tracked_bills: 0 }
            };
            updateStatsCards(stats);
        }

        function createChartsFromRealData(bills, totalBills) {
            try {
                // Count bills by state/federal
                const stateCount = {};
                bills.forEach(bill => {
                    const state = bill.state_or_federal || 'unknown';
                    stateCount[state] = (stateCount[state] || 0) + 1;
                });

                // Create bills by state chart
                try {
                    createBillsByStateChart(stateCount);
                } catch (error) {
                    console.error('‚ùå Failed to create bills by state chart:', error);
                }

                // Create mock activity timeline (since we don't have activity data)
                try {
                    const mockActivityData = Array.from({ length: 7 }, () => Math.floor(Math.random() * 10));
                    createActivityTimelineChart(mockActivityData.map(score => ({ activity_score: score })));
                } catch (error) {
                    console.error('‚ùå Failed to create activity timeline chart:', error);
                }

                console.log('üìà Charts creation attempt completed');
            } catch (error) {
                console.error('‚ùå Error in createChartsFromRealData:', error);
            }
        }

        async function loadRealBills(page = 1) {
            currentPage = page;
            showLoadingIndicator(true);

            try {
                // Read current filter values
                const jurisdictionFilter = document.getElementById('jurisdictionFilter').value;
                const industryFilter = document.getElementById('industryFilter').value;
                const relevanceFilter = document.getElementById('relevanceFilter').value;
                const keywordFilter = document.getElementById('keywordFilter').value;

                // For industry filtering, we need to fetch more data since it's client-side
                const pageSize = industryFilter ? '100' : '20';

                const params = new URLSearchParams({
                    page: industryFilter ? '1' : page.toString(), // Always get page 1 for industry filtering
                    page_size: pageSize
                });

                // Add server-side filters
                if (jurisdictionFilter) params.append('state', jurisdictionFilter);
                if (relevanceFilter) params.append('min_relevance_score', relevanceFilter);
                if (keywordFilter) params.append('search', keywordFilter);

                // Add sorting
                if (currentSort.field) {
                    params.append('sort_by', currentSort.field);
                    params.append('sort_order', currentSort.order);
                }

                console.log(`üì° Fetching bills from API: ${API_BASE_URL}${API_PREFIX}/bills/?${params}`);

                // Make direct API call without authentication
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/bills/?${params}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(`‚úÖ Loaded ${data.bills?.length || 0} bills from API`);

                    let allBills = data.bills || [];
                    let filteredBills = allBills;

                    // Apply client-side industry filtering
                    if (industryFilter) {
                        filteredBills = allBills.filter(bill => {
                            const billIndustry = getIndustryFromBill(bill);

                            if (industryFilter === 'Multi') {
                                return billIndustry.includes(', ');
                            } else {
                                return billIndustry === industryFilter || billIndustry.includes(industryFilter);
                            }
                        });

                        // Apply pagination to filtered results
                        const startIndex = (page - 1) * 20;
                        const endIndex = startIndex + 20;
                        filteredBills = filteredBills.slice(startIndex, endIndex);
                    }

                    bills = filteredBills;

                    // Calculate totals
                    const originalTotal = data.total || 0;
                    let filteredTotal;

                    if (industryFilter) {
                        // For industry filtering, we need to get the actual count of filtered results
                        const allFilteredBills = allBills.filter(bill => {
                            const billIndustry = getIndustryFromBill(bill);
                            if (industryFilter === 'Multi') {
                                return billIndustry.includes(', ');
                            } else {
                                return billIndustry === industryFilter || billIndustry.includes(industryFilter);
                            }
                        });
                        filteredTotal = allFilteredBills.length;
                    } else {
                        filteredTotal = originalTotal;
                    }

                    // Calculate pagination
                    totalPages = Math.ceil(filteredTotal / 20);

                    displayBills(filteredBills);

                    // Update pagination data
                    const paginationData = {
                        total: filteredTotal,
                        page: page,
                        page_size: filteredBills.length
                    };
                    updatePagination(paginationData);
                    updateBillsCount(filteredTotal);

                    // Create charts from real data (use all filtered bills for accurate charts)
                    const chartData = industryFilter ?
                        allBills.filter(bill => {
                            const billIndustry = getIndustryFromBill(bill);
                            if (industryFilter === 'Multi') {
                                return billIndustry.includes(', ');
                            } else {
                                return billIndustry === industryFilter || billIndustry.includes(industryFilter);
                            }
                        }) : allBills;

                    createChartsFromRealData(chartData, filteredTotal);
                } else {
                    console.error('API response not OK:', response.status, response.statusText);
                    throw new Error(`API request failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading bills:', error);
                showNotification(`Error loading bills: ${error.message}`, 'error');
                // Show empty state
                displayBills([]);
                updateBillsCount(0);
            } finally {
                showLoadingIndicator(false);
            }
        }

        // Backward compatibility function
        async function loadBills(page = 1) {
            return await loadRealBills(page);
        }

        // Utility function to analyze and display industry tagging for all bills
        async function analyzeIndustryTagging() {
            try {
                console.log('üè∑Ô∏è Starting industry tagging analysis...');

                // Get all bills from API
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/bills/?page_size=200`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const data = await response.json();
                    const allBills = data.bills || [];

                    console.log(`üìä Analyzing ${allBills.length} bills for industry tags...`);

                    const tagCounts = {
                        'SNF': 0,
                        'ALF': 0,
                        'HH': 0,
                        'HOS': 0,
                        'Multiple Tags': 0,
                        'Healthcare (Generic)': 0,
                        'Other': 0
                    };

                    const taggedBills = [];

                    allBills.forEach((bill, index) => {
                        const tags = autoTagIndustries(bill);
                        const industryDisplay = getIndustryFromBill(bill);

                        const billAnalysis = {
                            id: bill.id,
                            bill_number: bill.bill_number,
                            title: bill.title,
                            tags: tags,
                            industryDisplay: industryDisplay,
                            relevance_score: bill.relevance_score
                        };

                        taggedBills.push(billAnalysis);

                        // Count tags
                        if (tags.length > 1) {
                            tagCounts['Multiple Tags']++;
                        } else if (tags.length === 1) {
                            tagCounts[tags[0]]++;
                        } else if (industryDisplay === 'Healthcare') {
                            tagCounts['Healthcare (Generic)']++;
                        } else {
                            tagCounts['Other']++;
                        }
                    });

                    console.log('üìà Industry Tagging Results:');
                    console.table(tagCounts);

                    console.log('üè∑Ô∏è Sample Tagged Bills:');
                    taggedBills
                        .filter(b => b.tags.length > 0)
                        .slice(0, 10)
                        .forEach(bill => {
                            console.log(`${bill.bill_number}: [${bill.tags.join(', ')}] - ${bill.title.substring(0, 60)}...`);
                        });

                    // Show multi-tagged bills
                    const multiTagged = taggedBills.filter(b => b.tags.length > 1);
                    if (multiTagged.length > 0) {
                        console.log(`üéØ Bills with Multiple Tags (${multiTagged.length}):`);
                        multiTagged.forEach(bill => {
                            console.log(`${bill.bill_number}: [${bill.tags.join(', ')}] - ${bill.title.substring(0, 60)}...`);
                        });
                    }

                    return {
                        totalBills: allBills.length,
                        tagCounts: tagCounts,
                        taggedBills: taggedBills,
                        multiTagged: multiTagged
                    };
                }
            } catch (error) {
                console.error('Error analyzing industry tagging:', error);
            }
        }

        function displayBills(billsData) {
            const tbody = document.getElementById('billsTableBody');
            tbody.innerHTML = '';

            billsData.forEach(bill => {
                const row = createBillRow(bill);
                tbody.appendChild(row);
            });
        }

        function createBillRow(bill) {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 cursor-pointer transition-colors duration-150';

            const relevanceClass = getRelevanceClass(bill.relevance_score);

            const riskScoreData = getRiskScoreData(bill);
            const riskBadges = getRiskBadges(bill);

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${bill.bill_number || 'N/A'}
                </td>
                <td class="px-6 py-4 text-sm text-gray-900">
                    <div class="max-w-md leading-relaxed">
                        ${bill.title || 'No title'}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${relevanceClass}">
                        ${bill.relevance_score ? bill.relevance_score.toFixed(1) : 'N/A'}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center space-x-2">
                        <div class="tooltip-container">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${riskScoreData.class}">
                                ${riskScoreData.score}/100
                            </span>
                            <div class="tooltip breakdown">
                                <strong>Risk Breakdown:</strong><br>
                                üí∞ Reimbursement: ${bill.reimbursement_risk || 0}/40<br>
                                üë• Staffing: ${bill.staffing_risk || 0}/30<br>
                                üìã Compliance: ${bill.compliance_risk || 0}/20<br>
                                ‚≠ê Quality: ${bill.quality_risk || 0}/10
                            </div>
                        </div>
                        <div class="flex items-center space-x-1">
                            ${riskBadges}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="${getStatusClass(bill.status)}">
                        ${normalizeStatus(bill.status)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bill.state_or_federal === 'federal' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                        ${getJurisdictionDisplay(bill.state_or_federal)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getIndustryClass(getIndustryFromBill(bill))}">
                        ${getIndustryFromBill(bill)}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" onclick="event.stopPropagation()">
                    <button onclick="toggleBillDetails(${bill.id})" class="text-blue-600 hover:text-blue-900 mr-3 focus:outline-none">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button onclick="trackBill(${bill.id})" class="text-green-600 hover:text-green-900 focus:outline-none">
                        <i class="fas fa-plus"></i> Track
                    </button>
                </td>
            `;

            // Make entire row clickable except for the action buttons
            row.addEventListener('click', (e) => {
                if (!e.target.closest('button')) {
                    toggleBillDetails(bill.id);
                }
            });

            return row;
        }

        function getRelevanceClass(score) {
            if (!score) return 'relevance-very-low';
            if (score >= 80) return 'relevance-very-high';
            if (score >= 60) return 'relevance-high';
            if (score >= 40) return 'relevance-medium';
            if (score >= 20) return 'relevance-low';
            return 'relevance-very-low';
        }

        function getRiskScoreData(bill) {
            const totalRisk = bill.total_risk_score || 0;
            let riskClass = 'risk-score-minimal';

            if (totalRisk >= 70) {
                riskClass = 'risk-score-critical';
            } else if (totalRisk >= 40) {
                riskClass = 'risk-score-high';
            } else if (totalRisk >= 20) {
                riskClass = 'risk-score-moderate';
            } else if (totalRisk > 0) {
                riskClass = 'risk-score-low';
            }

            return {
                score: totalRisk,
                class: riskClass
            };
        }

        function getRiskBadges(bill) {
            const badges = [];

            // Reimbursement risk - Red money icon
            if (bill.reimbursement_risk && bill.reimbursement_risk > 0) {
                const intensity = getRiskIntensity(bill.reimbursement_risk, 40);
                const concerns = getReimbursementConcerns(bill.reimbursement_risk);
                badges.push(`
                    <div class="tooltip-container">
                        <span class="risk-badge reimbursement ${intensity}">üí∞</span>
                        <div class="tooltip concern reimbursement">
                            <strong>üí∞ Reimbursement Risk (${bill.reimbursement_risk}/40)</strong><br>
                            ${concerns}
                        </div>
                    </div>
                `);
            }

            // Staffing risk - Orange person icon
            if (bill.staffing_risk && bill.staffing_risk > 0) {
                const intensity = getRiskIntensity(bill.staffing_risk, 30);
                const concerns = getStaffingConcerns(bill.staffing_risk);
                badges.push(`
                    <div class="tooltip-container">
                        <span class="risk-badge staffing ${intensity}">üë•</span>
                        <div class="tooltip concern staffing">
                            <strong>üë• Staffing Risk (${bill.staffing_risk}/30)</strong><br>
                            ${concerns}
                        </div>
                    </div>
                `);
            }

            // Compliance risk - Yellow clipboard icon
            if (bill.compliance_risk && bill.compliance_risk > 0) {
                const intensity = getRiskIntensity(bill.compliance_risk, 20);
                const concerns = getComplianceConcerns(bill.compliance_risk);
                badges.push(`
                    <div class="tooltip-container">
                        <span class="risk-badge compliance ${intensity}">üìã</span>
                        <div class="tooltip concern compliance">
                            <strong>üìã Compliance Risk (${bill.compliance_risk}/20)</strong><br>
                            ${concerns}
                        </div>
                    </div>
                `);
            }

            // Quality risk - Purple star icon
            if (bill.quality_risk && bill.quality_risk > 0) {
                const intensity = getRiskIntensity(bill.quality_risk, 10);
                const concerns = getQualityConcerns(bill.quality_risk);
                badges.push(`
                    <div class="tooltip-container">
                        <span class="risk-badge quality ${intensity}">‚≠ê</span>
                        <div class="tooltip concern quality">
                            <strong>‚≠ê Quality Risk (${bill.quality_risk}/10)</strong><br>
                            ${concerns}
                        </div>
                    </div>
                `);
            }

            return badges.join('');
        }

        function getRiskIntensity(score, maxScore) {
            const percentage = (score / maxScore) * 100;

            if (percentage >= 75) {
                return 'dark';  // Dark color for high intensity
            } else if (percentage >= 50) {
                return 'medium';  // Medium color
            } else {
                return 'light';  // Light color for low intensity
            }
        }

        function getReimbursementConcerns(score) {
            if (score >= 30) {
                return "‚Ä¢ Potential payment cuts or rate reductions<br>‚Ä¢ Significant budget impact likely<br>‚Ä¢ Immediate financial planning required<br>‚Ä¢ Cash flow disruption possible";
            } else if (score >= 15) {
                return "‚Ä¢ Moderate reimbursement changes expected<br>‚Ä¢ Budget adjustments may be needed<br>‚Ä¢ Monitor payment methodology updates";
            } else {
                return "‚Ä¢ Minor payment adjustments possible<br>‚Ä¢ Routine rate updates likely<br>‚Ä¢ Minimal financial impact expected";
            }
        }

        function getStaffingConcerns(score) {
            if (score >= 22) {
                return "‚Ä¢ New minimum staffing ratios required<br>‚Ä¢ Significant hiring needs likely<br>‚Ä¢ Compliance deadlines to track<br>‚Ä¢ Higher operational costs expected";
            } else if (score >= 12) {
                return "‚Ä¢ Staffing requirement changes likely<br>‚Ä¢ Moderate hiring adjustments needed<br>‚Ä¢ Training requirements possible";
            } else {
                return "‚Ä¢ Minor staffing guideline updates<br>‚Ä¢ Limited operational impact<br>‚Ä¢ Standard compliance expected";
            }
        }

        function getComplianceConcerns(score) {
            if (score >= 15) {
                return "‚Ä¢ New reporting requirements mandatory<br>‚Ä¢ Additional documentation needed<br>‚Ä¢ Administrative burden increase<br>‚Ä¢ Compliance audits likely";
            } else if (score >= 8) {
                return "‚Ä¢ Moderate reporting changes<br>‚Ä¢ Updated procedures required<br>‚Ä¢ Training staff recommended";
            } else {
                return "‚Ä¢ Minor documentation updates<br>‚Ä¢ Routine compliance changes<br>‚Ä¢ Standard procedural adjustments";
            }
        }

        function getQualityConcerns(score) {
            if (score >= 8) {
                return "‚Ä¢ Quality measure penalties possible<br>‚Ä¢ Star Rating impact likely<br>‚Ä¢ QAPI program updates required<br>‚Ä¢ Performance monitoring critical";
            } else if (score >= 4) {
                return "‚Ä¢ Quality reporting changes expected<br>‚Ä¢ Star Rating methodology updates<br>‚Ä¢ Moderate performance impact";
            } else {
                return "‚Ä¢ Minor quality measure adjustments<br>‚Ä¢ Routine reporting updates<br>‚Ä¢ Standard quality initiatives";
            }
        }

        function getJurisdictionDisplay(stateOrFederal) {
            if (!stateOrFederal) return 'Unknown';
            if (stateOrFederal.toLowerCase() === 'federal') return 'Federal';

            // State abbreviation mapping for common states
            const stateMap = {
                'california': 'CA', 'texas': 'TX', 'florida': 'FL', 'new york': 'NY',
                'illinois': 'IL', 'pennsylvania': 'PA', 'ohio': 'OH', 'georgia': 'GA',
                'north carolina': 'NC', 'michigan': 'MI', 'new jersey': 'NJ', 'virginia': 'VA',
                'washington': 'WA', 'arizona': 'AZ', 'massachusetts': 'MA', 'tennessee': 'TN',
                'indiana': 'IN', 'missouri': 'MO', 'maryland': 'MD', 'wisconsin': 'WI',
                'colorado': 'CO', 'minnesota': 'MN', 'south carolina': 'SC', 'alabama': 'AL',
                'louisiana': 'LA', 'kentucky': 'KY', 'oregon': 'OR', 'oklahoma': 'OK',
                'connecticut': 'CT', 'utah': 'UT', 'iowa': 'IA', 'nevada': 'NV',
                'arkansas': 'AR', 'mississippi': 'MS', 'kansas': 'KS', 'new mexico': 'NM',
                'nebraska': 'NE', 'west virginia': 'WV', 'idaho': 'ID', 'hawaii': 'HI',
                'new hampshire': 'NH', 'maine': 'ME', 'rhode island': 'RI', 'montana': 'MT',
                'delaware': 'DE', 'south dakota': 'SD', 'north dakota': 'ND', 'alaska': 'AK',
                'vermont': 'VT', 'wyoming': 'WY'
            };

            const lowerState = stateOrFederal.toLowerCase();
            return stateMap[lowerState] || stateOrFederal.toUpperCase().substring(0, 2);
        }

        function autoTagIndustries(bill) {
            const text = `${bill.title || ''} ${bill.summary || ''} ${bill.bill_number || ''}`.toLowerCase();
            const tags = [];

            // SNF (Skilled Nursing Facility) keywords - exact matches
            const snfKeywords = [
                'skilled nursing', 'snf', 'nursing facility', 'nursing home',
                'long term care', 'long-term care', 'post acute', 'post-acute'
            ];

            // ALF (Assisted Living Facility) keywords - exact matches
            const alfKeywords = [
                'assisted living', 'alf', 'residential care', 'adult care',
                'senior living', 'independent living', 'memory care'
            ];

            // HH (Home Health) keywords - exact matches
            const hhKeywords = [
                'home health', 'home care', 'home healthcare', 'visiting nurse',
                'in-home care', 'homebound'
            ];

            // HOS (Hospice) keywords - exact matches
            const hosKeywords = [
                'hospice', 'hospice care', 'end of life', 'palliative care',
                'comfort care', 'terminal care'
            ];

            // Check for each industry type
            if (snfKeywords.some(keyword => text.includes(keyword))) {
                tags.push('SNF');
            }

            if (alfKeywords.some(keyword => text.includes(keyword))) {
                tags.push('ALF');
            }

            if (hhKeywords.some(keyword => text.includes(keyword))) {
                tags.push('HH');
            }

            if (hosKeywords.some(keyword => text.includes(keyword))) {
                tags.push('HOS');
            }

            return tags;
        }

        function getIndustryFromBill(bill) {
            const tags = autoTagIndustries(bill);

            if (tags.length === 0) {
                // If no specific tags found, check for general healthcare terms
                const text = `${bill.title || ''} ${bill.summary || ''}`.toLowerCase();
                const healthcareKeywords = ['healthcare', 'medical', 'health', 'medicare', 'medicaid'];
                if (healthcareKeywords.some(keyword => text.includes(keyword))) {
                    return 'Healthcare';
                }
                return 'Other';
            }

            // Return comma-separated tags for multiple matches
            return tags.join(', ');
        }

        function getIndustryClass(industry) {
            // Handle multiple tags
            if (industry.includes(', ')) {
                return 'bg-gradient-to-r from-blue-100 to-green-100 text-blue-800'; // Multi-tag gradient
            }

            const classMap = {
                'SNF': 'bg-blue-100 text-blue-800',
                'ALF': 'bg-green-100 text-green-800',
                'HH': 'bg-purple-100 text-purple-800',
                'HOS': 'bg-red-100 text-red-800',
                'Healthcare': 'bg-cyan-100 text-cyan-800',
                'Other': 'bg-gray-100 text-gray-800'
            };
            return classMap[industry] || 'bg-gray-100 text-gray-800';
        }

        function normalizeStatus(status) {
            if (!status) return 'Proposed';

            const statusLower = status.toLowerCase();

            // Map various status formats to standard ones
            if (statusLower.includes('introduced') || statusLower.includes('proposed')) {
                return 'Proposed';
            }
            if (statusLower.includes('committee') || statusLower.includes('referred')) {
                return 'In Committee';
            }
            if (statusLower.includes('passed house')) {
                return 'Passed House';
            }
            if (statusLower.includes('passed senate')) {
                return 'Passed Senate';
            }
            if (statusLower.includes('signed') || statusLower.includes('enacted')) {
                return 'Signed into Law';
            }
            if (statusLower.includes('final rule') || statusLower.includes('final regulation')) {
                return 'Final Rule';
            }
            if (statusLower.includes('comment') || statusLower.includes('notice')) {
                return 'In Comment Period';
            }

            // Default to the original status if no mapping found
            return status;
        }

        function getStatusClass(status) {
            const normalized = normalizeStatus(status);

            switch (normalized) {
                case 'Passed House':
                case 'Passed Senate':
                case 'Signed into Law':
                    return 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-passed';

                case 'In Committee':
                case 'In Comment Period':
                    return 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-pending';

                case 'Final Rule':
                    return 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-final';

                case 'Proposed':
                default:
                    return 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-proposed';
            }
        }

        function analyzeSNFImpacts(bill) {
            const text = `${bill.title || ''} ${bill.summary || ''}`.toLowerCase();
            const impacts = [];

            // Reimbursement impacts
            if (text.includes('medicare') && (text.includes('payment') || text.includes('reimbursement') || text.includes('rate'))) {
                impacts.push('üí∞ Medicare reimbursement changes');
            }
            if (text.includes('medicaid') && (text.includes('payment') || text.includes('reimbursement') || text.includes('rate'))) {
                impacts.push('üí∞ Medicaid reimbursement changes');
            }

            // Staffing impacts
            if (text.includes('staff') && (text.includes('ratio') || text.includes('requirement') || text.includes('minimum'))) {
                impacts.push('üë• Staffing requirements');
            }
            if (text.includes('nurse') && (text.includes('ratio') || text.includes('requirement'))) {
                impacts.push('üë• Nursing staffing requirements');
            }

            // Quality measures
            if (text.includes('quality') && (text.includes('measure') || text.includes('report') || text.includes('rating'))) {
                impacts.push('üìä Quality reporting requirements');
            }
            if (text.includes('inspection') || text.includes('survey') || text.includes('compliance')) {
                impacts.push('üìã Compliance and inspection changes');
            }

            // Infection control
            if (text.includes('infection') || text.includes('covid') || text.includes('safety protocol')) {
                impacts.push('ü¶† Infection control requirements');
            }

            return impacts;
        }

        function generateImportantDates(bill) {
            const dates = [];
            const today = new Date();

            // Mock date generation based on status for demonstration
            // In a real system, these would come from bill data
            const status = normalizeStatus(bill.status);

            if (status === 'In Comment Period') {
                // Generate a comment deadline (30-90 days from now)
                const commentDeadline = new Date(today);
                commentDeadline.setDate(today.getDate() + Math.floor(Math.random() * 60) + 30);

                const isUrgent = (commentDeadline - today) / (1000 * 60 * 60 * 24) <= 30;
                dates.push({
                    type: 'comment',
                    label: 'Comments due',
                    date: commentDeadline,
                    urgent: isUrgent
                });
            }

            if (status === 'Signed into Law' || status === 'Final Rule') {
                // Generate an effective date (6 months to 2 years from now)
                const effectiveDate = new Date(today);
                effectiveDate.setMonth(today.getMonth() + Math.floor(Math.random() * 18) + 6);

                dates.push({
                    type: 'effective',
                    label: 'Effective',
                    date: effectiveDate,
                    urgent: false
                });
            }

            return dates;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
        }

        async function toggleBillDetails(billId) {
            const existingDetailRow = document.getElementById(`details-${billId}`);

            if (existingDetailRow) {
                existingDetailRow.remove();
                return;
            }

            try {
                console.log(`üì° Fetching bill details for ID: ${billId}`);

                // Make direct API call without authentication
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/bills/${billId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const bill = await response.json();
                    console.log(`‚úÖ Loaded bill details:`, bill);
                    showBillDetails(bill);
                } else {
                    console.error('Bill details API response not OK:', response.status, response.statusText);
                    throw new Error(`API request failed: ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading bill details:', error);
                showNotification(`Error loading bill details: ${error.message}`, 'error');
            }
        }

        function showBillDetails(bill) {
            const billRow = Array.from(document.querySelectorAll('#billsTableBody tr')).find(row =>
                row.innerHTML.includes(bill.bill_number)
            );

            if (billRow) {
                const detailRow = document.createElement('tr');
                detailRow.id = `details-${bill.id}`;
                detailRow.className = 'expanded-row';

                detailRow.innerHTML = `
                    <td colspan="8" class="px-6 py-4">
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 mb-2">${bill.title}</h3>
                                    <div class="flex items-center space-x-4 text-sm text-gray-600">
                                        <span><strong>Bill #:</strong> ${bill.bill_number}</span>
                                        <span><strong>Sponsor:</strong> ${bill.sponsor || 'Unknown'}</span>
                                        <span><strong>Chamber:</strong> ${bill.chamber || 'Unknown'}</span>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="viewOriginalBill('${bill.bill_number}', '${bill.state_or_federal}')" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        View Original
                                    </button>
                                    <button onclick="toggleBillDetails(${bill.id})" class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-semibold text-gray-800 mb-3">üìÑ Full Summary</h4>
                                    <div class="bg-white rounded-lg p-4 text-sm text-gray-700 leading-relaxed max-h-60 overflow-y-auto">
                                        ${bill.summary || 'No summary available for this bill.'}
                                    </div>

                                    <div id="snfImpacts-${bill.id}" class="mt-4">
                                        <!-- SNF impacts will be populated here -->
                                    </div>

                                    <div id="importantDates-${bill.id}" class="mt-4">
                                        <!-- Important dates will be populated here -->
                                    </div>
                                </div>

                                <div>
                                    <!-- Tab Navigation -->
                                    <div class="border-b border-gray-200 mb-4">
                                        <nav class="-mb-px flex space-x-8">
                                            <button onclick="switchAnalysisTab(${bill.id}, 'gpt')"
                                                    id="gpt-tab-${bill.id}"
                                                    class="analysis-tab border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium">
                                                ü§ñ GPT Analysis
                                            </button>
                                            <button onclick="switchAnalysisTab(${bill.id}, 'risk')"
                                                    id="risk-tab-${bill.id}"
                                                    class="analysis-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                                                ‚ö†Ô∏è Risk Assessment
                                            </button>
                                            <button onclick="switchAnalysisTab(${bill.id}, 'questions')"
                                                    id="questions-tab-${bill.id}"
                                                    class="analysis-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                                                üí¨ Questions
                                            </button>
                                        </nav>
                                    </div>

                                    <!-- GPT Analysis Tab Content -->
                                    <div id="gpt-content-${bill.id}" class="tab-content">
                                        <div id="aiAnalysis-${bill.id}" class="bg-white rounded-lg p-4 text-sm text-gray-600 min-h-[120px]">
                                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading comprehensive AI analysis...
                                        </div>

                                        <div class="mt-4 bg-white rounded-lg p-4">
                                            <h5 class="font-medium text-gray-800 mb-2">‚ö†Ô∏è Risk Overview</h5>
                                            <div class="text-sm space-y-2">
                                                <div class="flex items-center justify-between">
                                                    <span class="flex items-center">
                                                        <span class="risk-badge reimbursement ${getRiskIntensity(bill.reimbursement_risk || 0, 40)} mr-2">üí∞</span>
                                                        Reimbursement Risk
                                                    </span>
                                                    <span class="font-medium">${bill.reimbursement_risk || 0}/40</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="flex items-center">
                                                        <span class="risk-badge staffing ${getRiskIntensity(bill.staffing_risk || 0, 30)} mr-2">üë•</span>
                                                        Staffing Risk
                                                    </span>
                                                    <span class="font-medium">${bill.staffing_risk || 0}/30</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="flex items-center">
                                                        <span class="risk-badge compliance ${getRiskIntensity(bill.compliance_risk || 0, 20)} mr-2">üìã</span>
                                                        Compliance Risk
                                                    </span>
                                                    <span class="font-medium">${bill.compliance_risk || 0}/20</span>
                                                </div>
                                                <div class="flex items-center justify-between">
                                                    <span class="flex items-center">
                                                        <span class="risk-badge quality ${getRiskIntensity(bill.quality_risk || 0, 10)} mr-2">‚≠ê</span>
                                                        Quality Risk
                                                    </span>
                                                    <span class="font-medium">${bill.quality_risk || 0}/10</span>
                                                </div>
                                                <hr class="my-2">
                                                <div class="flex items-center justify-between font-semibold">
                                                    <span>Total Risk Score</span>
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRiskScoreData(bill).class}">
                                                        ${bill.total_risk_score || 0}/100
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Risk Assessment Tab Content -->
                                    <div id="risk-content-${bill.id}" class="tab-content hidden">
                                        <div id="detailedRiskAnalysis-${bill.id}">
                                            <!-- Detailed risk analysis will be populated here -->
                                        </div>
                                    </div>

                                    <!-- Questions Tab Content -->
                                    <div id="questions-content-${bill.id}" class="tab-content hidden">
                                        <div id="billQuestions-${bill.id}">
                                            <!-- Questions and FAQ interface will be populated here -->
                                        </div>
                                    </div>

                                    <div class="mt-4 bg-white rounded-lg p-4">
                                        <h5 class="font-medium text-gray-800 mb-2">üìä Bill Metadata</h5>
                                        <div class="text-sm text-gray-600 space-y-1">
                                            <p><strong>Source:</strong> ${bill.source || 'Unknown'}</p>
                                            <p><strong>Last Action:</strong> ${bill.last_action_date ? new Date(bill.last_action_date).toLocaleDateString() : 'Unknown'}</p>
                                            <p><strong>Last Updated:</strong> ${bill.updated_at ? new Date(bill.updated_at).toLocaleDateString() : 'Unknown'}</p>
                                            <p><strong>Relevance Score:</strong> ${bill.relevance_score ? bill.relevance_score.toFixed(1) + '/100' : 'Not scored'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                `;

                billRow.after(detailRow);

                // Load AI analysis
                loadAIAnalysis(bill.id);

                // Populate SNF impacts
                populateSNFImpacts(bill);

                // Populate important dates
                populateImportantDates(bill);
            }
        }

        async function loadAIAnalysis(billId) {
            try {
                console.log(`ü§ñ Attempting to load AI analysis for bill ${billId}`);

                const analysisDiv = document.getElementById(`aiAnalysis-${billId}`);
                if (!analysisDiv) return;

                // Try to get AI analysis from the API
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/bills/${billId}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const analysisResult = await response.json();
                    const analysis = analysisResult.analysis;

                    let content = '<div class="space-y-3">';
                    content += `<div><strong>üìã Summary:</strong> ${analysis.one_line_summary || 'Analysis completed successfully.'}</div>`;

                    if (analysis.key_provisions_snf) {
                        content += `<div><strong>üè• SNF Provisions:</strong><br><div class="ml-4 text-sm">${analysis.key_provisions_snf}</div></div>`;
                    }

                    if (analysis.financial_impact) {
                        content += `<div><strong>üí∞ Financial Impact:</strong><br><div class="ml-4 text-sm">${analysis.financial_impact}</div></div>`;
                    }

                    if (analysis.action_required) {
                        content += `<div><strong>‚ö° Action Required:</strong><br><div class="ml-4 text-sm text-red-600">${analysis.action_required}</div></div>`;
                    }

                    if (analysis.analysis_confidence) {
                        const confidenceColor = analysis.analysis_confidence >= 80 ? 'text-green-600' : analysis.analysis_confidence >= 60 ? 'text-yellow-600' : 'text-red-600';
                        content += `<div class="text-sm"><strong>üéØ Confidence:</strong> <span class="${confidenceColor}">${analysis.analysis_confidence}%</span></div>`;
                    }

                    content += '</div>';
                    analysisDiv.innerHTML = content;
                    console.log(`‚úÖ AI analysis loaded for bill ${billId}`);
                } else if (response.status === 401) {
                    // Authentication required for analysis
                    analysisDiv.innerHTML = `
                        <div class="text-center p-4">
                            <i class="fas fa-lock text-gray-400 text-2xl mb-2"></i>
                            <p class="text-gray-600 mb-3">ü§ñ <strong>GPT Analysis Available</strong></p>
                            <p class="text-sm text-gray-500 mb-3">This bill has been analyzed using advanced AI to identify:</p>
                            <ul class="text-sm text-gray-600 text-left space-y-1 mb-3">
                                <li>‚Ä¢ SNF-specific regulatory impacts</li>
                                <li>‚Ä¢ Financial implications and timeline</li>
                                <li>‚Ä¢ Required compliance actions</li>
                                <li>‚Ä¢ Industry context and precedents</li>
                            </ul>
                            <p class="text-xs text-gray-500">Login required to view full analysis</p>
                        </div>
                    `;
                } else {
                    // Generate intelligent analysis based on bill content
                    const bill = bills.find(b => b.id === billId);
                    if (bill) {
                        const smartAnalysis = generateSmartAnalysis(bill);
                        analysisDiv.innerHTML = smartAnalysis;
                    } else {
                        analysisDiv.innerHTML = `
                            <div class="text-center p-4">
                                <i class="fas fa-robot text-blue-500 text-2xl mb-2"></i>
                                <p class="text-gray-600">ü§ñ AI analysis processing...</p>
                                <p class="text-sm text-gray-500">Analysis will appear here when available.</p>
                            </div>
                        `;
                    }
                    console.log(`‚ÑπÔ∏è AI analysis endpoint returned ${response.status} for bill ${billId}`);
                }
            } catch (error) {
                console.error('Error loading AI analysis:', error);
                const analysisDiv = document.getElementById(`aiAnalysis-${billId}`);
                if (analysisDiv) {
                    // Generate smart analysis as fallback
                    const bill = bills.find(b => b.id === billId);
                    if (bill) {
                        const smartAnalysis = generateSmartAnalysis(bill);
                        analysisDiv.innerHTML = smartAnalysis;
                    } else {
                        analysisDiv.innerHTML = `
                            <div class="text-center p-4 text-gray-600">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mb-2"></i>
                                <p>ü§ñ AI analysis temporarily unavailable</p>
                                <p class="text-sm text-gray-500">Please try refreshing the page</p>
                            </div>
                        `;
                    }
                }
            }
        }

        function generateSmartAnalysis(bill) {
            const text = `${bill.title} ${bill.summary || ''}`.toLowerCase();
            const impacts = analyzeSNFImpacts(bill);
            const tags = autoTagIndustries(bill);

            let analysis = '<div class="space-y-3">';

            // Generate intelligent summary based on content
            if (text.includes('medicare') && text.includes('payment')) {
                analysis += `<div><strong>üìã Quick Analysis:</strong> This legislation appears to modify Medicare payment structures, which could significantly impact SNF reimbursement rates and cash flow.</div>`;
            } else if (text.includes('staff') && text.includes('ratio')) {
                analysis += `<div><strong>üìã Quick Analysis:</strong> This bill focuses on staffing requirements, potentially increasing operational costs and compliance obligations for nursing facilities.</div>`;
            } else if (text.includes('quality') && text.includes('report')) {
                analysis += `<div><strong>üìã Quick Analysis:</strong> Quality reporting requirements are the focus, likely impacting administrative burden and Star Ratings methodology.</div>`;
            } else if (tags.length > 0) {
                analysis += `<div><strong>üìã Quick Analysis:</strong> This legislation directly impacts ${tags.join(' and ')} sectors, requiring careful monitoring for compliance and operational changes.</div>`;
            } else {
                analysis += `<div><strong>üìã Quick Analysis:</strong> This bill has been flagged for SNF relevance (Score: ${bill.relevance_score?.toFixed(1) || 'N/A'}) and requires further review for potential impacts.</div>`;
            }

            // Add impact analysis
            if (impacts.length > 0) {
                analysis += `<div><strong>üéØ Key Areas:</strong><ul class="ml-4 text-sm space-y-1">`;
                impacts.forEach(impact => {
                    analysis += `<li>‚Ä¢ ${impact.replace(/^[^a-zA-Z]*/, '')}</li>`;
                });
                analysis += `</ul></div>`;
            }

            // Add status-based timeline
            const status = normalizeStatus(bill.status);
            if (status === 'Proposed') {
                analysis += `<div><strong>‚è∞ Timeline:</strong> <span class="text-gray-600">Early stage - monitor for committee activity</span></div>`;
            } else if (status === 'In Committee') {
                analysis += `<div><strong>‚è∞ Timeline:</strong> <span class="text-yellow-600">Active review - potential amendments likely</span></div>`;
            } else if (status.includes('Passed')) {
                analysis += `<div><strong>‚è∞ Timeline:</strong> <span class="text-blue-600">Advanced stage - implementation planning recommended</span></div>`;
            } else if (status === 'Signed into Law') {
                analysis += `<div><strong>‚è∞ Timeline:</strong> <span class="text-green-600">Enacted - compliance preparation required</span></div>`;
            }

            analysis += `<div class="text-xs text-gray-500 mt-3 pt-3 border-t">‚ö° Smart Analysis ‚Ä¢ Generated based on bill content and relevance patterns</div>`;
            analysis += '</div>';

            return analysis;
        }

        function populateSNFImpacts(bill) {
            const impacts = analyzeSNFImpacts(bill);
            const impactsDiv = document.getElementById(`snfImpacts-${bill.id}`);

            if (impacts.length > 0 && impactsDiv) {
                let html = '<h4 class="font-semibold text-gray-800 mb-2">üè• SNF Impact Analysis</h4>';
                html += '<div class="snf-impact-highlight">';
                html += impacts.map(impact => `<div class="mb-1">‚Ä¢ ${impact}</div>`).join('');
                html += '</div>';
                impactsDiv.innerHTML = html;
            }
        }

        function populateImportantDates(bill) {
            const dates = generateImportantDates(bill);
            const datesDiv = document.getElementById(`importantDates-${bill.id}`);

            if (dates.length > 0 && datesDiv) {
                let html = '<h4 class="font-semibold text-gray-800 mb-2">üìÖ Important Dates</h4>';
                html += '<div class="space-y-2">';

                dates.forEach(dateInfo => {
                    const dateClass = dateInfo.urgent ? 'deadline-urgent' : 'text-gray-700';
                    const icon = dateInfo.type === 'comment' ? 'üí¨' : '‚ö°';

                    html += `<div class="flex items-center space-x-2">`;
                    html += `<span>${icon}</span>`;
                    html += `<span class="font-medium">${dateInfo.label}:</span>`;
                    html += `<span class="${dateClass}">${formatDate(dateInfo.date)}</span>`;
                    if (dateInfo.urgent) {
                        html += `<span class="text-red-600 text-xs ml-2">(‚ö†Ô∏è Within 30 days)</span>`;
                    }
                    html += `</div>`;
                });

                html += '</div>';
                datesDiv.innerHTML = html;
            }
        }

        function viewOriginalBill(billNumber, stateOrFederal) {
            let url = '';

            if (stateOrFederal && stateOrFederal.toLowerCase() === 'federal') {
                // For federal bills, construct Congress.gov URL
                // Extract congress and bill type from bill number
                // Format examples: HR1234, S567, HB890, SB123, etc.
                const billMatch = billNumber.match(/^([A-Z]+)\.?(\d+)$/i);

                if (billMatch) {
                    const billType = billMatch[1].toLowerCase();
                    const billNum = billMatch[2];

                    // Map common bill types to congress.gov format
                    const typeMap = {
                        'hr': 'house-bill',
                        'h': 'house-bill',
                        's': 'senate-bill',
                        'hres': 'house-resolution',
                        'sres': 'senate-resolution',
                        'hjres': 'house-joint-resolution',
                        'sjres': 'senate-joint-resolution',
                        'hconres': 'house-concurrent-resolution',
                        'sconres': 'senate-concurrent-resolution'
                    };

                    const congressType = typeMap[billType] || 'house-bill';
                    // Assuming 118th Congress (current as of 2023-2025)
                    const congress = 118;

                    url = `https://www.congress.gov/bill/${congress}th-congress/${congressType}/${billNum}`;
                } else {
                    // Fallback: search on congress.gov
                    url = `https://www.congress.gov/search?q=${encodeURIComponent(billNumber)}`;
                }
            } else {
                // For state bills, try to construct LegiScan URL or use search
                // LegiScan URL format is complex and varies by state
                // For now, use a general search approach
                const state = stateOrFederal ? stateOrFederal.toUpperCase() : '';
                url = `https://legiscan.com/search?state=${state}&bill=${encodeURIComponent(billNumber)}`;
            }

            if (url) {
                window.open(url, '_blank', 'noopener,noreferrer');
                console.log(`üîó Opening original bill: ${billNumber} at ${url}`);
            } else {
                showNotification(`‚ùå Could not generate URL for bill ${billNumber}`, 'error');
            }
        }

        async function trackBill(billId) {
            const bill = bills.find(b => b.id === billId);
            const billNumber = bill ? bill.bill_number : `Bill ${billId}`;

            // Since there's no authentication, show info about tracking
            showNotification(`‚ÑπÔ∏è To track ${billNumber}, please create an account and login to enable personalized alerts.`, 'info');

            // Show a demo of what tracking would look like
            setTimeout(() => {
                showRealtimeAlert({
                    title: 'Demo: Tracking Feature',
                    message: `This is what a tracking alert would look like for ${billNumber}. Login to enable real tracking!`
                });
            }, 2000);
        }

        async function loadChartData() {
            try {
                const [statsResponse, trendingResponse] = await Promise.all([
                    apiRequest('/dashboard/stats'),
                    apiRequest('/dashboard/trending?period=30d')
                ]);

                if (statsResponse.ok && trendingResponse.ok) {
                    const stats = await statsResponse.json();
                    const trending = await trendingResponse.json();

                    // Create charts with error handling
                    try {
                        createBillsByStateChart(stats.bill_stats?.bills_by_state || {});
                    } catch (error) {
                        console.error('‚ùå Failed to create bills by state chart from API data:', error);
                    }

                    try {
                        createActivityTimelineChart(trending.bills || []);
                    } catch (error) {
                        console.error('‚ùå Failed to create activity timeline chart from API data:', error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading chart data from API:', error);
            }
        }

        function createBillsByStateChart(data) {
            try {
                // Destroy existing chart instance if it exists
                if (window.billsByStateChart && window.billsByStateChart instanceof Chart) {
                    window.billsByStateChart.destroy();
                    window.billsByStateChart = null;
                }

                // Check if canvas element exists
                const canvasElement = document.getElementById('billsByStateChart');
                if (!canvasElement) {
                    console.warn('Canvas element billsByStateChart not found, skipping chart creation');
                    return;
                }

                const ctx = canvasElement.getContext('2d');
                if (!ctx) {
                    console.warn('Could not get 2D context for billsByStateChart');
                    return;
                }

                window.billsByStateChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            data: Object.values(data),
                            backgroundColor: [
                                '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });

                console.log('‚úÖ Bills by State chart created successfully');
            } catch (error) {
                console.error('‚ùå Error creating Bills by State chart:', error);
                window.billsByStateChart = null;
            }
        }

        function createActivityTimelineChart(bills) {
            try {
                // Destroy existing chart instance if it exists
                if (window.activityTimelineChart && window.activityTimelineChart instanceof Chart) {
                    window.activityTimelineChart.destroy();
                    window.activityTimelineChart = null;
                }

                // Check if canvas element exists
                const canvasElement = document.getElementById('activityTimelineChart');
                if (!canvasElement) {
                    console.warn('Canvas element activityTimelineChart not found, skipping chart creation');
                    return;
                }

                const ctx = canvasElement.getContext('2d');
                if (!ctx) {
                    console.warn('Could not get 2D context for activityTimelineChart');
                    return;
                }

                // Group bills by date for the last 7 days
                const last7Days = [];
                const today = new Date();

                for (let i = 6; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    last7Days.push(date.toISOString().split('T')[0]);
                }

                const activityData = last7Days.map(() => Math.floor(Math.random() * 10)); // Mock data

                window.activityTimelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(date => new Date(date).toLocaleDateString()),
                        datasets: [{
                            label: 'Bill Activity',
                            data: activityData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                console.log('‚úÖ Activity Timeline chart created successfully');
            } catch (error) {
                console.error('‚ùå Error creating Activity Timeline chart:', error);
                window.activityTimelineChart = null;
            }
        }

        function setupWebSocket() {
            try {
                // Note: WebSocket implementation would depend on your backend setup
                // This is a mock implementation showing the structure
                websocket = new WebSocket(`ws://localhost:8000/ws/alerts?token=${accessToken}`);

                websocket.onopen = () => {
                    console.log('WebSocket connected');
                    updateConnectionStatus(true);
                };

                websocket.onmessage = (event) => {
                    const alert = JSON.parse(event.data);
                    showRealtimeAlert(alert);
                };

                websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);

                    // Attempt to reconnect after 5 seconds
                    setTimeout(() => {
                        if (accessToken) setupWebSocket();
                    }, 5000);
                };

                websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };

            } catch (error) {
                console.error('Error setting up WebSocket:', error);
                // Fallback to polling for alerts
                pollForAlerts();
            }
        }

        function pollForAlerts() {
            setInterval(async () => {
                try {
                    const response = await apiRequest('/alerts/?unread_only=true&page_size=1');
                    if (response.ok) {
                        const data = await response.json();
                        // Check for new alerts logic would go here
                    }
                } catch (error) {
                    console.error('Error polling for alerts:', error);
                }
            }, 30000); // Poll every 30 seconds
        }

        function showRealtimeAlert(alert) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-notification bg-blue-600 text-white px-4 py-3 rounded-lg shadow-lg max-w-sm';

            alertDiv.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <h4 class="font-semibold">${alert.title || 'New Alert'}</h4>
                        <p class="text-sm mt-1">${alert.message || alert.description}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById('alertContainer').appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = indicator.nextElementSibling;

            if (connected) {
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'Connected';
            } else {
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Disconnected';
            }
        }

        function handleSort(field) {
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }

            // Update sort indicators
            document.querySelectorAll('th[data-sort] i').forEach(i => {
                i.className = 'fas fa-sort ml-1';
            });

            const currentHeader = document.querySelector(`th[data-sort="${field}"] i`);
            currentHeader.className = `fas fa-sort-${currentSort.order === 'asc' ? 'up' : 'down'} ml-1`;

            loadBills(1);
        }

        function applyFilters() {
            // Reset to first page when applying filters
            currentPage = 1;
            loadRealBills(1);
        }

        function clearFilters() {
            document.getElementById('jurisdictionFilter').value = '';
            document.getElementById('industryFilter').value = '';
            document.getElementById('relevanceFilter').value = '';
            document.getElementById('keywordFilter').value = '';

            // Reset to first page and reload
            currentPage = 1;
            loadRealBills(1);
        }

        function changePage(page) {
            if (page >= 1 && page <= totalPages) {
                loadBills(page);
            }
        }

        function updatePagination(data) {
            const showingStart = (currentPage - 1) * 20 + 1;
            const showingEnd = Math.min(currentPage * 20, data.total);

            document.getElementById('showingStart').textContent = showingStart;
            document.getElementById('showingEnd').textContent = showingEnd;
            document.getElementById('totalResults').textContent = data.total;

            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;

            // Generate page numbers
            generatePageNumbers();
        }

        function generatePageNumbers() {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            pageNumbersDiv.innerHTML = '';

            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.className = `px-3 py-2 text-sm border border-gray-300 rounded-md ${
                    i === currentPage
                        ? 'bg-blue-600 text-white border-blue-600'
                        : 'bg-white text-gray-500 hover:bg-gray-50'
                }`;
                button.textContent = i;
                button.addEventListener('click', () => changePage(i));
                pageNumbersDiv.appendChild(button);
            }
        }

        function updateBillsCount(total) {
            document.getElementById('billsCount').textContent = `(${total})`;
        }

        function showLoadingIndicator(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert-notification px-4 py-3 rounded-lg shadow-lg max-w-sm ${
                type === 'success' ? 'bg-green-600 text-white' :
                type === 'error' ? 'bg-red-600 text-white' :
                type === 'warning' ? 'bg-yellow-600 text-white' :
                'bg-blue-600 text-white'
            }`;

            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById('alertContainer').appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const url = `${API_BASE_URL}${API_PREFIX}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (accessToken) {
                options.headers['Authorization'] = `Bearer ${accessToken}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(url, options);

            // Handle token expiration
            if (response.status === 401 && accessToken) {
                // Try to refresh token
                const refreshed = await refreshAccessToken();
                if (refreshed) {
                    options.headers['Authorization'] = `Bearer ${accessToken}`;
                    return fetch(url, options);
                } else {
                    handleLogout();
                }
            }

            return response;
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) return false;

            try {
                const response = await fetch(`${API_BASE_URL}${API_PREFIX}/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    accessToken = data.access_token;
                    localStorage.setItem('accessToken', accessToken);
                    localStorage.setItem('refreshToken', data.refresh_token);
                    return true;
                }
            } catch (error) {
                console.error('Token refresh error:', error);
            }

            return false;
        }

        // Tab switching functionality for expanded bill view
        function switchAnalysisTab(billId, tabType) {
            // Update tab buttons
            const gptTab = document.getElementById(`gpt-tab-${billId}`);
            const riskTab = document.getElementById(`risk-tab-${billId}`);
            const questionsTab = document.getElementById(`questions-tab-${billId}`);
            const gptContent = document.getElementById(`gpt-content-${billId}`);
            const riskContent = document.getElementById(`risk-content-${billId}`);
            const questionsContent = document.getElementById(`questions-content-${billId}`);

            // Reset all tabs to inactive state
            const inactiveClass = 'analysis-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium';
            const activeClass = 'analysis-tab border-b-2 border-blue-500 text-blue-600 py-2 px-1 text-sm font-medium';

            gptTab.className = inactiveClass;
            riskTab.className = inactiveClass;
            questionsTab.className = inactiveClass;

            gptContent.className = 'tab-content hidden';
            riskContent.className = 'tab-content hidden';
            questionsContent.className = 'tab-content hidden';

            // Activate selected tab
            if (tabType === 'gpt') {
                gptTab.className = activeClass;
                gptContent.className = 'tab-content';
            } else if (tabType === 'risk') {
                riskTab.className = activeClass;
                riskContent.className = 'tab-content';
                // Load detailed risk analysis when switching to risk tab
                loadDetailedRiskAnalysis(billId);
            } else if (tabType === 'questions') {
                questionsTab.className = activeClass;
                questionsContent.className = 'tab-content';
                // Load questions interface when switching to questions tab
                loadQuestionsInterface(billId);
            }
        }

        // Load detailed risk analysis
        function loadDetailedRiskAnalysis(billId) {
            const analysisContainer = document.getElementById(`detailedRiskAnalysis-${billId}`);
            if (!analysisContainer) return;

            // Find the bill data from the stored bills or create mock data
            const bill = getCurrentBillData(billId);
            analysisContainer.innerHTML = generateDetailedRiskAnalysis(bill);
        }

        // Get current bill data (simplified approach)
        function getCurrentBillData(billId) {
            // Try to find bill in mockBills first
            let bill = mockBills.find(b => b.id == billId);
            if (!bill) {
                // Create mock bill data for demonstration
                bill = {
                    id: billId,
                    title: "Sample Legislation with Risk Assessment",
                    reimbursement_risk: Math.floor(Math.random() * 30) + 10,
                    staffing_risk: Math.floor(Math.random() * 20) + 5,
                    compliance_risk: Math.floor(Math.random() * 15) + 5,
                    quality_risk: Math.floor(Math.random() * 8) + 2,
                    total_risk_score: 0,
                    risk_tags: '["moderate_risk", "reimbursement_concerns"]'
                };
                bill.total_risk_score = bill.reimbursement_risk + bill.staffing_risk + bill.compliance_risk + bill.quality_risk;
            }
            return bill;
        }

        // Generate detailed risk analysis HTML
        function generateDetailedRiskAnalysis(bill) {
            const reimbRisk = bill.reimbursement_risk || 0;
            const staffRisk = bill.staffing_risk || 0;
            const compRisk = bill.compliance_risk || 0;
            const qualRisk = bill.quality_risk || 0;
            const totalRisk = bill.total_risk_score || 0;

            let html = `
                <div class="space-y-6">
                    <!-- Risk Score Overview -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">üìä Risk Assessment Overview</h3>
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${getRiskScoreData(bill).class}">
                                ${totalRisk}/100 - ${getRiskLevel(totalRisk)}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-2xl font-bold text-gray-900">${totalRisk}</div>
                                <div class="text-sm text-gray-600">Total Risk Score</div>
                            </div>
                            <div class="text-center p-3 bg-gray-50 rounded">
                                <div class="text-2xl font-bold text-red-600">$${calculateEstimatedImpact(totalRisk).toLocaleString()}</div>
                                <div class="text-sm text-gray-600">Est. Annual Impact</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Category Breakdown -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìà Risk Category Analysis</h3>
                        <div class="space-y-4">
                            ${generateCategoryAnalysis('üí∞', 'Reimbursement Risk', reimbRisk, 40, 'reimbursement')}
                            ${generateCategoryAnalysis('üë•', 'Staffing Risk', staffRisk, 30, 'staffing')}
                            ${generateCategoryAnalysis('üìã', 'Compliance Risk', compRisk, 20, 'compliance')}
                            ${generateCategoryAnalysis('‚≠ê', 'Quality Risk', qualRisk, 10, 'quality')}
                        </div>
                    </div>

                    <!-- Specific Concerns -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">‚ö†Ô∏è Specific Concerns</h3>
                        ${generateSpecificConcerns(bill)}
                    </div>

                    <!-- Compliance Deadlines -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">üìÖ Compliance Deadlines</h3>
                        ${generateComplianceDeadlines(bill)}
                    </div>

                    <!-- Mitigation Strategies -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">üõ°Ô∏è Mitigation Strategies</h3>
                        ${generateMitigationStrategies(bill)}
                    </div>
                </div>
            `;

            return html;
        }

        // Generate category analysis
        function generateCategoryAnalysis(icon, title, score, maxScore, category) {
            const percentage = Math.round((score / maxScore) * 100);
            const intensity = getRiskIntensity(score, maxScore);

            return `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <span class="text-xl mr-2">${icon}</span>
                            <span class="font-medium text-gray-900">${title}</span>
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium risk-badge ${category} ${intensity}">
                            ${score}/${maxScore}
                        </span>
                    </div>
                    <div class="mb-2">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Risk Level</span>
                            <span>${percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r ${getProgressBarColor(percentage)} h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600">
                        ${getCategoryInsight(category, score, maxScore)}
                    </div>
                </div>
            `;
        }

        // Get risk level text
        function getRiskLevel(score) {
            if (score >= 70) return 'CRITICAL';
            if (score >= 40) return 'HIGH';
            if (score >= 20) return 'MODERATE';
            if (score > 0) return 'LOW';
            return 'MINIMAL';
        }

        // Calculate estimated financial impact
        function calculateEstimatedImpact(riskScore) {
            const baseImpact = 100000;
            const impactMultiplier = Math.pow(riskScore / 100, 1.5);
            return Math.round(baseImpact * impactMultiplier);
        }

        // Get progress bar color based on percentage
        function getProgressBarColor(percentage) {
            if (percentage >= 70) return 'from-red-500 to-red-600';
            if (percentage >= 40) return 'from-orange-500 to-orange-600';
            if (percentage >= 20) return 'from-yellow-500 to-yellow-600';
            return 'from-green-500 to-green-600';
        }

        // Get category insight
        function getCategoryInsight(category, score, maxScore) {
            const percentage = Math.round((score / maxScore) * 100);

            switch(category) {
                case 'reimbursement':
                    if (percentage >= 70) return 'Severe payment reductions or rate cuts likely. Immediate financial planning required.';
                    if (percentage >= 40) return 'Moderate payment impacts expected. Review reimbursement strategies.';
                    if (percentage >= 20) return 'Minor payment adjustments possible. Monitor for updates.';
                    return 'Minimal reimbursement impact anticipated.';

                case 'staffing':
                    if (percentage >= 70) return 'Significant staffing requirements or mandates. HR planning critical.';
                    if (percentage >= 40) return 'New staffing standards likely. Evaluate current levels.';
                    if (percentage >= 20) return 'Possible staffing adjustments needed. Review adequacy.';
                    return 'Limited staffing impact expected.';

                case 'compliance':
                    if (percentage >= 70) return 'Major new compliance requirements. Legal review recommended.';
                    if (percentage >= 40) return 'Additional reporting or documentation needed. Plan resources.';
                    if (percentage >= 20) return 'Some new compliance elements. Review current practices.';
                    return 'Minimal compliance changes anticipated.';

                case 'quality':
                    if (percentage >= 70) return 'Significant quality measure changes. QA program review needed.';
                    if (percentage >= 40) return 'Quality reporting modifications likely. Update systems.';
                    if (percentage >= 20) return 'Minor quality adjustments possible. Monitor metrics.';
                    return 'Limited quality impact expected.';

                default:
                    return 'Impact assessment available upon further analysis.';
            }
        }

        // Generate specific concerns
        function generateSpecificConcerns(bill) {
            const concerns = [];
            const riskTags = JSON.parse(bill.risk_tags || '[]');

            if (bill.reimbursement_risk >= 20) {
                concerns.push('‚Ä¢ Medicare/Medicaid payment rate reductions may impact revenue by 5-15%');
                concerns.push('‚Ä¢ New payment methodologies could require system updates');
            }

            if (bill.staffing_risk >= 15) {
                concerns.push('‚Ä¢ Minimum staffing ratios may require additional FTE hiring');
                concerns.push('‚Ä¢ Nurse-to-patient ratio compliance could increase labor costs by 10-25%');
            }

            if (bill.compliance_risk >= 10) {
                concerns.push('‚Ä¢ New reporting requirements will increase administrative burden');
                concerns.push('‚Ä¢ Documentation standards may need policy updates and staff training');
            }

            if (bill.quality_risk >= 5) {
                concerns.push('‚Ä¢ Quality measure changes could affect star ratings and reimbursement');
                concerns.push('‚Ä¢ Performance penalties may apply for non-compliance');
            }

            if (riskTags.includes('payment_cuts')) {
                concerns.push('‚Ä¢ Direct payment reductions identified in bill text');
            }

            if (riskTags.includes('staffing_mandates')) {
                concerns.push('‚Ä¢ Mandatory staffing requirements specified');
            }

            if (concerns.length === 0) {
                return '<p class="text-gray-600 text-sm">No specific concerns identified at current risk levels.</p>';
            }

            return `<ul class="text-sm text-gray-700 space-y-2">${concerns.join('<br>')}</ul>`;
        }

        // Generate compliance deadlines
        function generateComplianceDeadlines(bill) {
            const deadlines = [];

            if (bill.reimbursement_risk >= 15) {
                deadlines.push({
                    date: 'January 1, 2025',
                    item: 'New payment rates effective',
                    severity: 'high'
                });
            }

            if (bill.staffing_risk >= 15) {
                deadlines.push({
                    date: 'July 1, 2025',
                    item: 'Minimum staffing ratios compliance required',
                    severity: 'high'
                });
            }

            if (bill.compliance_risk >= 10) {
                deadlines.push({
                    date: 'October 1, 2025',
                    item: 'New reporting requirements begin',
                    severity: 'medium'
                });
            }

            if (bill.quality_risk >= 5) {
                deadlines.push({
                    date: 'April 1, 2026',
                    item: 'Quality measure updates take effect',
                    severity: 'medium'
                });
            }

            if (deadlines.length === 0) {
                return '<p class="text-gray-600 text-sm">No specific compliance deadlines detected. Monitor for implementation timeline updates.</p>';
            }

            let html = '<div class="space-y-3">';
            deadlines.forEach(deadline => {
                const severityColor = deadline.severity === 'high' ?
                    'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200';
                const textColor = deadline.severity === 'high' ? 'text-red-800' : 'text-yellow-800';
                const badgeColor = deadline.severity === 'high' ?
                    'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700';

                html += `
                    <div class="flex items-center justify-between p-3 rounded-lg border ${severityColor} ${textColor}">
                        <div>
                            <div class="font-medium">${deadline.item}</div>
                            <div class="text-sm opacity-75">Effective: ${deadline.date}</div>
                        </div>
                        <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${badgeColor}">
                            ${deadline.severity.toUpperCase()}
                        </span>
                    </div>
                `;
            });
            html += '</div>';

            return html;
        }

        // Generate mitigation strategies
        function generateMitigationStrategies(bill) {
            const strategies = [];

            if (bill.reimbursement_risk >= 15) {
                strategies.push({
                    category: 'üí∞ Financial Planning',
                    actions: [
                        'Conduct revenue impact analysis and budget adjustments',
                        'Explore alternative revenue streams and payer mix optimization',
                        'Review and renegotiate vendor contracts to reduce costs'
                    ]
                });
            }

            if (bill.staffing_risk >= 15) {
                strategies.push({
                    category: 'üë• Staffing Strategy',
                    actions: [
                        'Begin recruitment for additional nursing staff',
                        'Evaluate current staffing ratios against new requirements',
                        'Consider staffing agency partnerships for flexibility'
                    ]
                });
            }

            if (bill.compliance_risk >= 10) {
                strategies.push({
                    category: 'üìã Compliance Preparation',
                    actions: [
                        'Update policies and procedures to meet new standards',
                        'Train staff on new documentation requirements',
                        'Implement or upgrade compliance tracking systems'
                    ]
                });
            }

            if (bill.quality_risk >= 5) {
                strategies.push({
                    category: '‚≠ê Quality Improvement',
                    actions: [
                        'Review and enhance Quality Assurance Performance Improvement (QAPI) programs',
                        'Update quality metric tracking and reporting processes',
                        'Provide additional training on quality measures'
                    ]
                });
            }

            if (bill.total_risk_score >= 20) {
                strategies.push({
                    category: 'üõ°Ô∏è General Risk Management',
                    actions: [
                        'Establish a legislative monitoring and response team',
                        'Engage with industry associations for advocacy efforts',
                        'Develop contingency plans for various implementation scenarios'
                    ]
                });
            }

            if (strategies.length === 0) {
                return '<p class="text-gray-600 text-sm">Current risk levels do not require specific mitigation strategies. Continue standard operational monitoring.</p>';
            }

            let html = '<div class="space-y-4">';
            strategies.forEach(strategy => {
                html += `
                    <div class="border border-gray-200 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-2">${strategy.category}</h4>
                        <ul class="text-sm text-gray-700 space-y-1">
                `;
                strategy.actions.forEach(action => {
                    html += `<li class="flex items-start"><span class="mr-2">‚Ä¢</span>${action}</li>`;
                });
                html += '</ul></div>';
            });
            html += '</div>';

            return html;
        }

        // Load questions interface
        function loadQuestionsInterface(billId) {
            const questionsContainer = document.getElementById(`billQuestions-${billId}`);
            if (!questionsContainer) return;

            // Find the bill data
            const bill = getCurrentBillData(billId);
            questionsContainer.innerHTML = generateQuestionsInterface(bill);
        }

        // Generate questions interface HTML
        function generateQuestionsInterface(bill) {
            const riskLevel = getRiskLevel(bill.total_risk_score || 0);
            const commonQuestions = getCommonQuestions(bill);

            let html = `
                <div class="space-y-6">
                    <!-- Header with Download button -->
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">üí¨ Questions & Answers</h3>
                        <button onclick="downloadQA(${bill.id})"
                                class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            <i class="fas fa-download mr-2"></i>
                            Download Q&A
                        </button>
                    </div>

                    <!-- Custom Question Input -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-3">Ask a Custom Question</h4>
                        <div class="flex space-x-3">
                            <input type="text" id="customQuestion-${bill.id}"
                                   placeholder="e.g., How will this bill affect small SNFs differently?"
                                   class="flex-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                   onkeypress="handleQuestionKeyPress(event, ${bill.id})">
                            <button onclick="askCustomQuestion(${bill.id})"
                                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Ask
                            </button>
                        </div>
                    </div>

                    <!-- Pre-populated FAQs -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-4">Frequently Asked Questions</h4>
                        <div class="space-y-3">
            `;

            commonQuestions.forEach((question, index) => {
                html += `
                    <button onclick="askPresetQuestion(${bill.id}, '${question.replace(/'/g, "\\'")}', ${index})"
                            class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                        <div class="flex items-start">
                            <i class="fas fa-question-circle text-blue-500 mt-1 mr-3"></i>
                            <span class="text-sm text-gray-700">${question}</span>
                        </div>
                    </button>
                `;
            });

            html += `
                        </div>
                    </div>

                    <!-- Q&A History -->
                    <div class="bg-white rounded-lg p-6 border border-gray-200">
                        <h4 class="font-medium text-gray-900 mb-4">Q&A History</h4>
                        <div id="qaHistory-${bill.id}" class="space-y-4">
                            <p class="text-sm text-gray-500 italic">No questions asked yet. Ask a question above to get started!</p>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // Get common questions based on bill characteristics
        function getCommonQuestions(bill) {
            const questions = [
                "How will this affect my facility's reimbursement?",
                "What's the compliance deadline?",
                "Who needs to take action?",
                "What are the penalties for non-compliance?"
            ];

            // Add risk-specific questions
            if (bill.reimbursement_risk >= 15) {
                questions.push("How much will our revenue decrease?");
                questions.push("Are there ways to offset payment reductions?");
            }

            if (bill.staffing_risk >= 15) {
                questions.push("How many additional staff will we need?");
                questions.push("What are the minimum staffing requirements?");
            }

            if (bill.compliance_risk >= 10) {
                questions.push("What new documentation is required?");
                questions.push("How often do we need to report?");
            }

            if (bill.quality_risk >= 5) {
                questions.push("How will this affect our star ratings?");
                questions.push("What quality measures are changing?");
            }

            // Add general questions
            questions.push("When does this take effect?");
            questions.push("Does this apply to all facility sizes?");
            questions.push("Are there any exemptions available?");

            return questions.slice(0, 8); // Limit to 8 questions
        }

        // Handle Enter key press in question input
        function handleQuestionKeyPress(event, billId) {
            if (event.key === 'Enter') {
                askCustomQuestion(billId);
            }
        }

        // Ask a custom question
        async function askCustomQuestion(billId) {
            const questionInput = document.getElementById(`customQuestion-${billId}`);
            const question = questionInput.value.trim();

            if (!question) {
                showNotification('Please enter a question', 'error');
                return;
            }

            questionInput.value = '';
            await processQuestion(billId, question);
        }

        // Ask a preset question
        async function askPresetQuestion(billId, question, index) {
            await processQuestion(billId, question);
        }

        // Process question and get GPT response
        async function processQuestion(billId, question) {
            const qaHistoryContainer = document.getElementById(`qaHistory-${billId}`);
            if (!qaHistoryContainer) return;

            // Add question to history immediately
            const questionId = `q-${billId}-${Date.now()}`;
            addQuestionToHistory(qaHistoryContainer, question, questionId);

            try {
                // Get bill context
                const bill = getCurrentBillData(billId);

                // Simulate GPT API call (in real implementation, this would call your API)
                const response = await simulateGPTResponse(question, bill);

                // Update the question with the response
                updateQuestionResponse(questionId, response);

                // Store question for FAQ database
                storeQuestionForFAQ(question, response, bill);

            } catch (error) {
                console.error('Error processing question:', error);
                updateQuestionResponse(questionId, 'Sorry, I encountered an error processing your question. Please try again.');
            }
        }

        // Add question to history
        function addQuestionToHistory(container, question, questionId) {
            // Remove "no questions" message if it exists
            if (container.innerHTML.includes('No questions asked yet')) {
                container.innerHTML = '';
            }

            const questionHtml = `
                <div id="${questionId}" class="border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start mb-3">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-user text-blue-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900">You asked:</p>
                            <p class="text-sm text-gray-700 mt-1">${question}</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-robot text-green-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3 flex-1">
                            <p class="text-sm font-medium text-gray-900">AI Response:</p>
                            <div class="response-content mt-1">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    Generating response...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('afterbegin', questionHtml);
        }

        // Update question with response
        function updateQuestionResponse(questionId, response) {
            const questionElement = document.getElementById(questionId);
            if (!questionElement) return;

            const responseContainer = questionElement.querySelector('.response-content');
            if (responseContainer) {
                responseContainer.innerHTML = `<p class="text-sm text-gray-700">${response}</p>`;
            }
        }

        // Simulate GPT response (replace with actual API call)
        async function simulateGPTResponse(question, bill) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

            const responses = {
                'reimbursement': `Based on the bill analysis, this legislation could impact your facility's reimbursement by approximately ${Math.floor(Math.random() * 15) + 5}%. The changes would take effect on ${new Date(2025, 0, 1).toLocaleDateString()}, giving you time to prepare financially.`,
                'compliance': `The compliance deadline appears to be ${new Date(2025, 6, 1).toLocaleDateString()}. You'll need to update your documentation processes and may need to assign additional staff to compliance activities.`,
                'action': `Your facility's administrator and compliance officer should take immediate action. Consider forming a task force to address the changes, and engage with your legal counsel to ensure full compliance.`,
                'penalties': `Non-compliance could result in penalties ranging from ${Math.floor(Math.random() * 50000) + 10000} to ${Math.floor(Math.random() * 100000) + 50000} per violation, depending on severity. Repeat violations may result in program exclusion.`,
                'staffing': `Based on the risk analysis, you may need to hire ${Math.floor(Math.random() * 5) + 2} additional staff members to meet the new requirements. Consider starting recruitment early as the healthcare labor market is competitive.`,
                'revenue': `Revenue impact could be ${Math.floor(Math.random() * 20) + 10}% reduction in the first year. Consider diversifying services or improving efficiency to offset losses.`
            };

            // Simple keyword matching for demo
            const lowerQuestion = question.toLowerCase();
            if (lowerQuestion.includes('reimbursement') || lowerQuestion.includes('payment') || lowerQuestion.includes('revenue')) {
                return responses.reimbursement;
            } else if (lowerQuestion.includes('deadline') || lowerQuestion.includes('when')) {
                return responses.compliance;
            } else if (lowerQuestion.includes('who') || lowerQuestion.includes('action')) {
                return responses.action;
            } else if (lowerQuestion.includes('penalt') || lowerQuestion.includes('fine')) {
                return responses.penalties;
            } else if (lowerQuestion.includes('staff') || lowerQuestion.includes('hire') || lowerQuestion.includes('employee')) {
                return responses.staffing;
            } else if (lowerQuestion.includes('revenue') || lowerQuestion.includes('decrease') || lowerQuestion.includes('much')) {
                return responses.revenue;
            } else {
                return `Thank you for your question about "${question}". Based on the bill analysis, this appears to be a ${getRiskLevel(bill.total_risk_score || 0).toLowerCase()}-risk legislation. I recommend consulting with your compliance team and legal counsel for facility-specific guidance. The estimated impact timeline is 6-12 months from enactment.`;
            }
        }

        // Store question for FAQ database
        function storeQuestionForFAQ(question, response, bill) {
            // In a real implementation, this would store to a database
            const faqEntry = {
                question: question,
                response: response,
                billId: bill.id,
                timestamp: new Date().toISOString(),
                riskLevel: getRiskLevel(bill.total_risk_score || 0)
            };

            // For demo, just log to console
            console.log('üìù Storing FAQ entry:', faqEntry);
        }

        // Download Q&A
        function downloadQA(billId) {
            const qaContainer = document.getElementById(`qaHistory-${billId}`);
            if (!qaContainer) return;

            const bill = getCurrentBillData(billId);
            let qaText = `Q&A Summary for: ${bill.title}\n`;
            qaText += `Bill ID: ${bill.bill_number || bill.id}\n`;
            qaText += `Generated: ${new Date().toLocaleString()}\n`;
            qaText += `Risk Level: ${getRiskLevel(bill.total_risk_score || 0)}\n\n`;

            // Extract Q&A pairs
            const qaElements = qaContainer.querySelectorAll('[id^="q-"]');
            if (qaElements.length === 0) {
                qaText += "No questions have been asked yet.\n";
            } else {
                qaElements.forEach((element, index) => {
                    const questionText = element.querySelector('.text-gray-700').textContent;
                    const responseText = element.querySelector('.response-content .text-gray-700')?.textContent || 'No response yet';

                    qaText += `Q${index + 1}: ${questionText}\n`;
                    qaText += `A${index + 1}: ${responseText}\n\n`;
                });
            }

            // Create and download file
            const blob = new Blob([qaText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bill-${bill.id}-qa-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Q&A summary downloaded successfully', 'success');
        }

    </script>
</body>
</html>