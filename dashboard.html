<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNF Legislation Tracker - Unified Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            font-size: 14px;
            line-height: 1.5;
        }
        .container {
            max-width: 1900px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #28a745 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
        }

        /* Facility Calculator */
        .calculator-container {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 6px solid #2196f3;
        }
        .calculator-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .calculator-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1976d2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .collapse-toggle {
            background: #2196f3;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: auto;
        }
        .collapse-toggle:hover {
            background: #1976d2;
        }
        .collapse-toggle.collapsed {
            background: #666;
        }

        .calculator-content {
            display: block;
            transition: all 0.3s ease;
        }
        .calculator-content.collapsed {
            display: none;
        }

        .facility-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .input-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .section-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 0.95rem;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        .input-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .input-group:last-child {
            margin-bottom: 0;
        }
        .input-group label {
            font-weight: 500;
            color: #555;
            flex: 1;
            font-size: 0.9rem;
        }
        .input-group input {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            width: 80px;
            text-align: center;
            transition: border-color 0.2s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #2196f3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .calculator-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .calculate-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        .reset-btn {
            padding: 12px 20px;
            background: #f8f9fa;
            color: #666;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reset-btn:hover {
            background: #e9ecef;
            color: #333;
        }
        .report-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        .report-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .impact-results {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        .impact-results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        .results-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 15px;
            text-align: center;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }
        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 5px;
        }
        .result-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .urgent-stat .stat-number {
            color: #dc3545;
        }

        /* Bills Container */
        .bills-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .bills-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .bills-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .bills-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #e9ecef;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
        }
        .bills-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }
        .bills-table tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .bills-table tr:hover {
            background-color: #f8f9fa;
        }
        .bill-title {
            font-weight: 600;
            color: #333;
            max-width: 350px;
        }

        /* Badges and Scores */
        .ai-score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            text-align: center;
            min-width: 40px;
        }
        .score-95 { background: #dc3545; }
        .score-70 { background: #fd7e14; }
        .score-60 { background: #ffc107; color: #333; }

        .financial-impact {
            font-weight: bold;
            padding: 6px 12px;
            border-radius: 12px;
            text-align: center;
            min-width: 80px;
            font-size: 12px;
        }
        .impact-high-positive { background: #d4edda; color: #155724; }
        .impact-medium-positive { background: #fff3cd; color: #856404; }
        .impact-low-positive { background: #f8f9fa; color: #495057; }
        .impact-negative { background: #f8d7da; color: #721c24; }

        .impact-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        .impact-direct { background: #e3f2fd; color: #1976d2; }
        .impact-financial { background: #f3e5f5; color: #7b1fa2; }
        .impact-competitive { background: #fff3e0; color: #f57c00; }
        .impact-workforce { background: #e8f5e8; color: #388e3c; }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .status-published { background: #d4edda; color: #155724; }
        .status-comment { background: #fff3cd; color: #856404; }
        .status-committee { background: #d1ecf1; color: #0c5460; }
        .status-passed { background: #d4edda; color: #155724; }
        .status-introduced { background: #f8d7da; color: #721c24; }

        .rule-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .rule-final { background: #28a745; color: white; }
        .rule-proposed { background: #ffc107; color: #333; }
        .rule-bill { background: #6f42c1; color: white; }

        .comment-deadline {
            font-weight: 500;
        }
        .deadline-urgent {
            color: #dc3545;
            font-weight: bold;
        }
        .deadline-normal {
            color: #28a745;
        }
        .days-remaining {
            font-weight: bold;
            font-size: 12px;
        }
        .days-urgent {
            color: #dc3545;
        }
        .days-normal {
            color: #28a745;
        }

        .view-button {
            display: inline-block;
            padding: 4px 12px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            transition: background 0.2s;
        }
        .view-button:hover {
            background: #5a6fd8;
            text-decoration: none;
            color: white;
        }

        .date-cell {
            white-space: nowrap;
            font-size: 12px;
        }

        .expand-btn {
            background: #6f42c1;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .expand-btn:hover {
            background: #5a32a3;
        }
        .expand-btn.expanded {
            background: #28a745;
        }

        /* Expandable Row */
        .expandable-row {
            display: none;
        }
        .expandable-row.expanded {
            display: table-row;
        }
        .expandable-content {
            padding: 20px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        /* Facility Impact Section */
        .facility-impact-section {
            background: linear-gradient(135deg, #fff9c4 0%, #f0f4c3 100%);
            border: 2px solid #fdd835;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .facility-impact-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f57c00;
            margin-bottom: 15px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .facility-impact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .facility-impact-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .facility-impact-value {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .facility-impact-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }
        .impact-positive {
            color: #2e7d32;
        }
        .impact-negative {
            color: #c62828;
        }
        .impact-neutral {
            color: #1976d2;
        }

        .facility-total-card {
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            grid-column: span 2;
            position: relative;
        }
        .facility-total-gain {
            background: linear-gradient(135deg, #2e7d32, #43a047);
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        }
        .facility-total-loss {
            background: linear-gradient(135deg, #c62828, #e53935);
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3);
        }
        .facility-total-neutral {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
        }
        .facility-total-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .facility-total-label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
        }

        .per-day-impacts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .per-day-card {
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .per-day-value {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .per-day-label {
            font-size: 0.75rem;
            color: #666;
        }

        /* Impact Breakdown in Expanded Section */
        .impact-categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .impact-category-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .category-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }
        .category-score {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
        }
        .progress-high { background: linear-gradient(90deg, #dc3545 0%, #c82333 100%); }
        .progress-moderate { background: linear-gradient(90deg, #ffc107 0%, #e0a800 100%); }
        .progress-low { background: linear-gradient(90deg, #28a745 0%, #20c997 100%); }
        .burden-level {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        .burden-high { color: #dc3545; }
        .burden-moderate { color: #ffc107; }
        .burden-low { color: #28a745; }

        /* Rule Summary Sections */
        .summary-section {
            margin-bottom: 20px;
        }
        .summary-title {
            font-size: 1rem;
            font-weight: 600;
            color: #6f42c1;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .executive-summary {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
            line-height: 1.6;
            color: #555;
            font-size: 0.9rem;
        }
        .provisions-list {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .provision-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.85rem;
        }
        .provision-item:last-child {
            border-bottom: none;
        }
        .provision-bullet {
            color: #6f42c1;
            font-weight: bold;
            margin-top: 2px;
        }

        .timeline-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .timeline-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #e9ecef;
            font-size: 0.8rem;
        }
        .timeline-item.completed { border-left-color: #28a745; }
        .timeline-item.in_progress { border-left-color: #ffc107; }
        .timeline-item.upcoming { border-left-color: #6f42c1; }
        .timeline-date {
            font-weight: 600;
            color: #333;
        }
        .timeline-milestone {
            font-weight: 500;
            color: #6f42c1;
            margin: 3px 0;
        }
        .timeline-description {
            color: #666;
        }

        .action-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .action-category {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .action-category-header {
            padding: 10px 15px;
            background: #6f42c1;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .priority-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
        }
        .priority-high { background: #dc3545; }
        .priority-medium { background: #ffc107; color: #333; }
        .action-items {
            padding: 0;
        }
        .action-item {
            padding: 8px 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 0.8rem;
        }
        .action-item:last-child {
            border-bottom: none;
        }
        .action-bullet {
            color: #6f42c1;
            font-weight: bold;
            margin-top: 2px;
        }

        /* Financial Legend */
        .financial-legend {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .financial-legend h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: white;
        }
        .legend-green {
            background: #28a745;
        }
        .legend-red {
            background: #dc3545;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .facility-inputs {
                grid-template-columns: 1fr;
            }
            .calculator-actions {
                flex-direction: column;
                gap: 10px;
            }
            .calculator-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .collapse-toggle {
                margin-left: 0;
            }
            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 SNF Legislation Tracker - Unified Dashboard</h1>
            <div>🤖 AI-Powered • Financial Impact • Rule Summaries • 4-Category Breakdown • Real-Time Analysis</div>
        </div>

        <!-- Facility Calculator -->
        <div class="calculator-container">
            <div class="calculator-header" onclick="toggleCalculator()">
                <div class="calculator-title">
                    🏥 My Facility Calculator
                </div>
                <button class="collapse-toggle" id="calculatorToggle">Hide Calculator</button>
            </div>

            <div class="calculator-content" id="calculatorContent">
                <!-- Facility Inputs -->
                <div class="facility-inputs">
                    <!-- Census Information -->
                    <div class="input-section">
                        <div class="section-title">📊 Census Information</div>
                        <div class="input-group">
                            <label for="totalCensus">Total Facility Census:</label>
                            <input type="number" id="totalCensus" value="120" min="0" max="500">
                        </div>
                        <div class="input-group">
                            <label for="medicareSkilled">Medicare Skilled Census:</label>
                            <input type="number" id="medicareSkilled" value="85" min="0" max="500">
                        </div>
                        <div class="input-group">
                            <label for="medicaidSkilled">Medicaid Skilled Census:</label>
                            <input type="number" id="medicaidSkilled" value="25" min="0" max="500">
                        </div>
                        <div class="input-group">
                            <label for="medicaidLongTerm">Medicaid Long-Term Census:</label>
                            <input type="number" id="medicaidLongTerm" value="10" min="0" max="500">
                        </div>
                    </div>

                    <!-- Staffing Information -->
                    <div class="input-section">
                        <div class="section-title">👥 Current Staffing (Optional)</div>
                        <div class="input-group">
                            <label for="nursingPPD">Current Nursing PPD:</label>
                            <input type="number" id="nursingPPD" value="3.2" min="0" max="10" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="therapyPPD">Current Therapy PPD:</label>
                            <input type="number" id="therapyPPD" value="1.8" min="0" max="10" step="0.1">
                        </div>
                    </div>
                </div>

                <!-- Calculator Actions -->
                <div class="calculator-actions">
                    <button class="calculate-btn" onclick="calculateMyImpact()">
                        📊 Calculate My Impact
                    </button>
                    <button class="reset-btn" onclick="resetCalculator()">
                        🔄 Reset Values
                    </button>
                    <button class="report-btn" onclick="generateFacilityReport()" id="reportBtn" disabled>
                        📄 Download Facility Report
                    </button>
                </div>

                <!-- Impact Results -->
                <div class="impact-results" id="impactResults">
                    <div class="results-title">📈 Your Facility Impact Analysis</div>
                    <div class="results-grid" id="resultsGrid">
                        <!-- Results will be populated here -->
                    </div>

                    <!-- Financial Notation Legend -->
                    <div class="financial-legend">
                        <h4>📊 Financial Notation Guide</h4>
                        <div class="legend-grid">
                            <div class="legend-item">
                                <div class="legend-color legend-green">+</div>
                                <span><strong>Green/+:</strong> Money gained (rate increases, cost savings)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-red">-</div>
                                <span><strong>Red/-:</strong> Money lost (rate decreases, added costs)</span>
                            </div>
                            <div class="legend-item">
                                <div style="font-weight: 600; color: #495057;">💰 Revenue Impact:</div>
                                <span>Changes to Medicare/Medicaid reimbursement rates</span>
                            </div>
                            <div class="legend-item">
                                <div style="font-weight: 600; color: #495057;">💸 Additional Costs:</div>
                                <span>New staffing/compliance requirements that cost money</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-style: italic; color: #6c757d;">
                            <strong>NET Impact</strong> = Revenue Changes - Cost Increases (standard accounting)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Bills Table -->
        <div class="bills-container">
            <div class="bills-header">
                <h2>📊 Comprehensive SNF Legislation Analysis</h2>
                <p>Complete analysis including financial impact, rule summaries, and 4-category breakdown. Click any row to expand.</p>
            </div>
            <table class="bills-table">
                <thead>
                    <tr>
                        <th>AI Score</th>
                        <th>Title</th>
                        <th>Financial Impact</th>
                        <th>Impact Type</th>
                        <th>Status</th>
                        <th>Rule Type</th>
                        <th>Introduced</th>
                        <th>Comment Deadline</th>
                        <th>Effective Date</th>
                        <th>View Rule</th>
                        <th>Expand</th>
                    </tr>
                </thead>
                <tbody id="billsTableBody">
                    <!-- Bills will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- jsPDF Library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Comprehensive bill data with all features
        const dashboardData = {
            "bills": [
                {
                    "id": 104,
                    "title": "Medicare Program; Hospital Inpatient Prospective Payment Systems for Acute Care Hospitals (IPPS)",
                    "ai_relevance_score": 95,
                    "ai_impact_type": "direct",
                    "ai_explanation": "Directly impacts SNF Medicare payments, quality measures, and operational requirements.",
                    "introduced_date": "2025-09-18",
                    "status": "Published",
                    "rule_type": "Final Rule",
                    "effective_date": "2025-11-27",
                    "comment_deadline": null,
                    "days_until_deadline": null,
                    "comment_period_urgent": false,
                    "rule_source_url": "https://www.federalregister.gov/documents/2025/08/15/2025-00104",
                    "financial_impact_pbpy": 1880,
                    "overall_score": 7.2,
                    "executive_summary": "This final rule updates the prospective payment system for fiscal year 2026, implementing significant changes to reimbursement rates and quality measures. The rule affects Medicare payments to skilled nursing facilities and introduces new operational requirements for compliance and reporting. Key changes include updated payment rates, revised quality indicators, and enhanced documentation requirements to improve patient care outcomes.",
                    "key_provisions": [
                        "Updated Medicare reimbursement rates effective October 1, 2025",
                        "New quality reporting requirements for Patient Driven Payment Model (PDPM)",
                        "Enhanced documentation standards for therapy services",
                        "Revised clinical assessment protocols and reporting timelines",
                        "Updated discharge planning and care coordination requirements"
                    ],
                    "implementation_timeline": [
                        {"date": "2025-08-15", "milestone": "Rule Publication", "description": "Final rule published in Federal Register", "status": "completed"},
                        {"date": "2025-09-15", "milestone": "Systems Preparation", "description": "Begin updating systems and training staff", "status": "in_progress"},
                        {"date": "2025-10-27", "milestone": "Effective Date", "description": "Rule becomes effective - full compliance required", "status": "upcoming"},
                        {"date": "2025-11-26", "milestone": "First Reporting Period", "description": "Submit first reports under new requirements", "status": "upcoming"},
                        {"date": "2026-01-25", "milestone": "Compliance Review", "description": "CMS begins compliance audits and monitoring", "status": "upcoming"}
                    ],
                    "snf_action_items": [
                        {
                            "category": "Systems & Technology",
                            "priority": "High",
                            "items": [
                                "Update billing and claims processing systems for new rates",
                                "Modify electronic health record templates for enhanced documentation",
                                "Test system interfaces and data validation procedures"
                            ]
                        },
                        {
                            "category": "Staff Training",
                            "priority": "High",
                            "items": [
                                "Train nursing staff on new clinical assessment requirements",
                                "Update therapy documentation protocols and procedures",
                                "Educate administrative staff on new reporting timelines"
                            ]
                        },
                        {
                            "category": "Compliance & Monitoring",
                            "priority": "Medium",
                            "items": [
                                "Review and update internal compliance policies",
                                "Establish new quality assurance monitoring procedures",
                                "Create audit trail documentation for regulatory reviews"
                            ]
                        }
                    ],
                    "impact_breakdown": {
                        "financial": {"score": 7, "burden_level": "high", "details": ["Payment system modifications required", "Medicare payment methodology changes"]},
                        "staffing": {"score": 2, "burden_level": "low", "details": ["General care quality impact on staffing"]},
                        "quality": {"score": 10, "burden_level": "high", "details": ["Quality measurement requirements", "Hospital readmission tracking", "Clinical assessment accuracy requirements"]},
                        "compliance": {"score": 10, "burden_level": "high", "details": ["Enhanced documentation standards", "New reporting obligations", "Increased audit and review activity"]}
                    }
                },
                {
                    "id": 105,
                    "title": "Medicare Program; Prospective Payment System and Consolidated Billing for Skilled Nursing Facilities",
                    "ai_relevance_score": 95,
                    "ai_impact_type": "direct",
                    "ai_explanation": "Directly impacts SNF Medicare payments, quality measures, and operational requirements.",
                    "introduced_date": "2025-09-18",
                    "status": "Comment Period Open",
                    "rule_type": "Proposed Rule",
                    "effective_date": "2025-10-03",
                    "comment_deadline": "2025-10-10",
                    "days_until_deadline": 20,
                    "comment_period_urgent": true,
                    "rule_source_url": "https://www.federalregister.gov/documents/2025/08/15/2025-00105",
                    "financial_impact_pbpy": 2500,
                    "overall_score": 5.8,
                    "executive_summary": "This final rule updates the prospective payment system for fiscal year 2026, implementing significant changes to reimbursement rates and quality measures. The rule affects Medicare payments to skilled nursing facilities and introduces new operational requirements for compliance and reporting.",
                    "key_provisions": [
                        "Updated Medicare reimbursement rates effective October 1, 2025",
                        "New quality reporting requirements for Patient Driven Payment Model (PDPM)",
                        "Enhanced documentation standards for therapy services",
                        "Revised clinical assessment protocols and reporting timelines",
                        "Updated discharge planning and care coordination requirements"
                    ],
                    "implementation_timeline": [
                        {"date": "2025-08-13", "milestone": "Rule Publication", "description": "Proposed rule published in Federal Register", "status": "completed"},
                        {"date": "2025-09-03", "milestone": "Systems Preparation", "description": "Begin updating systems and training staff", "status": "in_progress"},
                        {"date": "2025-10-03", "milestone": "Effective Date", "description": "Rule becomes effective - full compliance required", "status": "upcoming"},
                        {"date": "2025-11-02", "milestone": "First Reporting Period", "description": "Submit first reports under new requirements", "status": "upcoming"},
                        {"date": "2026-01-01", "milestone": "Compliance Review", "description": "CMS begins compliance audits and monitoring", "status": "upcoming"}
                    ],
                    "snf_action_items": [
                        {
                            "category": "Systems & Technology",
                            "priority": "High",
                            "items": [
                                "Update billing and claims processing systems for new rates",
                                "Modify electronic health record templates for enhanced documentation",
                                "Test system interfaces and data validation procedures"
                            ]
                        },
                        {
                            "category": "Staff Training",
                            "priority": "High",
                            "items": [
                                "Train nursing staff on new clinical assessment requirements",
                                "Update therapy documentation protocols and procedures",
                                "Educate administrative staff on new reporting timelines"
                            ]
                        }
                    ],
                    "impact_breakdown": {
                        "financial": {"score": 7, "burden_level": "high", "details": ["Payment system modifications required", "Medicare payment methodology changes"]},
                        "staffing": {"score": 6, "burden_level": "moderate", "details": ["Staffing-related requirements identified", "Clinical assessment training required"]},
                        "quality": {"score": 3, "burden_level": "low", "details": ["Quality measurement requirements", "Clinical assessment accuracy requirements"]},
                        "compliance": {"score": 7, "burden_level": "high", "details": ["Enhanced documentation standards", "New reporting obligations"]}
                    }
                },
                {
                    "id": 58,
                    "title": "A bill to amend title XVIII of the Social Security Act to apply improved prompt payment requirements",
                    "ai_relevance_score": 70,
                    "ai_impact_type": "financial",
                    "ai_explanation": "Payment changes may affect SNF reimbursement rates and financial planning.",
                    "introduced_date": "2025-09-18",
                    "status": "Comment Period Open",
                    "rule_type": "Proposed Rule",
                    "effective_date": "2025-10-01",
                    "comment_deadline": "2025-10-25",
                    "days_until_deadline": 35,
                    "comment_period_urgent": false,
                    "rule_source_url": "https://www.congress.gov/bill/118th-congress/house-bill/58",
                    "financial_impact_pbpy": 1500,
                    "overall_score": 3.5,
                    "executive_summary": "This legislation amends Medicare payment requirements to improve prompt payment processing for healthcare providers. The bill establishes new timelines for claim processing, penalty structures for delayed payments, and enhanced transparency requirements that will affect SNF cash flow management and administrative processes.",
                    "key_provisions": [
                        "Modified payment processing timelines and penalty structures",
                        "New transparency requirements for billing and claims processing",
                        "Updated appeals process for denied or delayed claims",
                        "Enhanced audit procedures and compliance monitoring",
                        "Revised cost-sharing and beneficiary responsibility calculations"
                    ],
                    "implementation_timeline": [
                        {"date": "2025-08-01", "milestone": "Rule Publication", "description": "Proposed rule published in Federal Register", "status": "completed"},
                        {"date": "2025-09-01", "milestone": "Systems Preparation", "description": "Begin updating systems and training staff", "status": "in_progress"},
                        {"date": "2025-10-01", "milestone": "Effective Date", "description": "Rule becomes effective - full compliance required", "status": "upcoming"},
                        {"date": "2025-10-31", "milestone": "First Reporting Period", "description": "Submit first reports under new requirements", "status": "upcoming"},
                        {"date": "2025-12-30", "milestone": "Compliance Review", "description": "CMS begins compliance audits and monitoring", "status": "upcoming"}
                    ],
                    "snf_action_items": [
                        {
                            "category": "Financial Management",
                            "priority": "High",
                            "items": [
                                "Update cash flow projections based on new payment timelines",
                                "Review accounts receivable processes and aging reports",
                                "Establish new billing and collections procedures"
                            ]
                        },
                        {
                            "category": "Administrative Processes",
                            "priority": "Medium",
                            "items": [
                                "Update claims submission and tracking procedures",
                                "Review appeals and denial management processes",
                                "Train billing staff on new requirements and penalties"
                            ]
                        }
                    ],
                    "impact_breakdown": {
                        "financial": {"score": 7, "burden_level": "high", "details": ["Payment system modifications required"]},
                        "staffing": {"score": 2, "burden_level": "low", "details": ["General care quality impact on staffing"]},
                        "quality": {"score": 2, "burden_level": "low", "details": ["General regulatory quality impact"]},
                        "compliance": {"score": 3, "burden_level": "low", "details": ["General compliance requirements"]}
                    }
                }
            ]
        };

        function loadDashboard() {
            displayStats();
            displayBillsTable(dashboardData.bills);

            // Load saved facility data if available
            const dataLoaded = loadFacilityData();
            if (dataLoaded) {
                // Auto-calculate if saved data exists
                setTimeout(() => {
                    calculateMyImpact();
                }, 500);
            }
        }

        function displayStats() {
            const bills = dashboardData.bills;
            const urgentComments = bills.filter(b => b.comment_period_urgent);
            const highImpact = bills.filter(b => b.ai_relevance_score >= 90);
            const commentPeriods = bills.filter(b => b.comment_deadline);
            const totalFinancialImpact = bills.reduce((sum, b) => sum + (b.financial_impact_pbpy || 0), 0);
            const avgFinancialImpact = totalFinancialImpact / bills.length;

            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${bills.length}</div>
                    <div class="stat-label">SNF-Relevant Bills</div>
                </div>
                <div class="stat-card urgent-stat">
                    <div class="stat-number">${urgentComments.length}</div>
                    <div class="stat-label">Urgent Comment Periods</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${highImpact.length}</div>
                    <div class="stat-label">Critical Impact (90+)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">$${avgFinancialImpact.toFixed(0)}</div>
                    <div class="stat-label">Avg Impact PBPY</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${commentPeriods.length}</div>
                    <div class="stat-label">Active Comment Periods</div>
                </div>
            `;
        }

        function displayBillsTable(bills) {
            const tbody = document.getElementById('billsTableBody');
            const rows = bills.map(bill => {
                const scoreClass = `score-${bill.ai_relevance_score}`;
                const impactClass = `impact-${bill.ai_impact_type}`;
                const statusClass = getStatusClass(bill.status);
                const ruleTypeClass = getRuleTypeClass(bill.rule_type);
                const financialClass = getFinancialImpactClass(bill.financial_impact_pbpy);

                const commentDeadlineCell = bill.comment_deadline ?
                    `<div class="comment-deadline ${bill.comment_period_urgent ? 'deadline-urgent' : 'deadline-normal'}">
                        ${formatDate(bill.comment_deadline)}<br>
                        <span class="days-remaining ${bill.comment_period_urgent ? 'days-urgent' : 'days-normal'}">
                            ${bill.days_until_deadline} days left
                        </span>
                    </div>` :
                    '<span style="color: #999;">No comment period</span>';

                return `
                    <tr onclick="toggleExpand(${bill.id})">
                        <td><div class="ai-score ${scoreClass}">${bill.ai_relevance_score}</div></td>
                        <td><div class="bill-title">${bill.title}</div></td>
                        <td><div class="financial-impact ${financialClass}">+$${bill.financial_impact_pbpy.toLocaleString()} PBPY</div></td>
                        <td><div class="impact-badge ${impactClass}">${getImpactEmoji(bill.ai_impact_type)} ${bill.ai_impact_type}</div></td>
                        <td><div class="status-badge ${statusClass}">${bill.status}</div></td>
                        <td><div class="rule-type-badge ${ruleTypeClass}">${bill.rule_type}</div></td>
                        <td><div class="date-cell">${formatDate(bill.introduced_date)}</div></td>
                        <td>${commentDeadlineCell}</td>
                        <td><div class="date-cell">${formatDate(bill.effective_date)}</div></td>
                        <td><a href="${bill.rule_source_url}" target="_blank" class="view-button" onclick="event.stopPropagation()">View Rule</a></td>
                        <td><button class="expand-btn" id="btn-${bill.id}" onclick="event.stopPropagation(); toggleExpand(${bill.id})">📋</button></td>
                    </tr>
                    <tr class="expandable-row" id="expand-${bill.id}">
                        <td colspan="11">
                            <div class="expandable-content">
                                ${createExpandedContent(bill)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;
        }

        function createExpandedContent(bill) {
            const facilityImpactHtml = createFacilityImpactSection(bill);

            return `
                ${facilityImpactHtml}

                <!-- 4-Category Impact Breakdown -->
                <div class="summary-section">
                    <div class="summary-title">📊 Impact Breakdown (Overall: ${bill.overall_score}/10)</div>
                    <div class="impact-categories-grid">
                        ${createImpactCategoryCard('💰', 'Financial', bill.impact_breakdown.financial)}
                        ${createImpactCategoryCard('👥', 'Staffing', bill.impact_breakdown.staffing)}
                        ${createImpactCategoryCard('⭐', 'Quality', bill.impact_breakdown.quality)}
                        ${createImpactCategoryCard('📋', 'Compliance', bill.impact_breakdown.compliance)}
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="summary-section">
                    <div class="summary-title">📄 Executive Summary</div>
                    <div class="executive-summary">${bill.executive_summary}</div>
                </div>

                <!-- Key Provisions -->
                <div class="summary-section">
                    <div class="summary-title">📋 Key Provisions</div>
                    <div class="provisions-list">
                        ${bill.key_provisions.map(provision =>
                            `<div class="provision-item">
                                <div class="provision-bullet">•</div>
                                <div>${provision}</div>
                            </div>`
                        ).join('')}
                    </div>
                </div>

                <!-- Implementation Timeline -->
                <div class="summary-section">
                    <div class="summary-title">📅 Implementation Timeline</div>
                    <div class="timeline-container">
                        ${bill.implementation_timeline.map(item =>
                            `<div class="timeline-item ${item.status}">
                                <div class="timeline-date">${formatDate(item.date)}</div>
                                <div class="timeline-milestone">${item.milestone}</div>
                                <div class="timeline-description">${item.description}</div>
                            </div>`
                        ).join('')}
                    </div>
                </div>

                <!-- What SNFs Need to Do -->
                <div class="summary-section">
                    <div class="summary-title">✅ What SNFs Need to Do</div>
                    <div class="action-categories">
                        ${bill.snf_action_items.map(category =>
                            `<div class="action-category">
                                <div class="action-category-header">
                                    <span>${category.category}</span>
                                    <span class="priority-badge priority-${category.priority.toLowerCase()}">${category.priority} Priority</span>
                                </div>
                                <div class="action-items">
                                    ${category.items.map(item =>
                                        `<div class="action-item">
                                            <div class="action-bullet">▶</div>
                                            <div>${item}</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        function createFacilityImpactSection(bill) {
            // Get current facility data from form or defaults
            const totalCensus = parseInt(document.getElementById('totalCensus')?.value || 120);
            const medicareSkilled = parseInt(document.getElementById('medicareSkilled')?.value || 85);
            const medicaidSkilled = parseInt(document.getElementById('medicaidSkilled')?.value || 25);
            const medicaidLongTerm = parseInt(document.getElementById('medicaidLongTerm')?.value || 10);

            // Calculate bill-specific impacts
            const billImpact = calculateBillSpecificImpact(bill, {
                totalCensus,
                medicareSkilled,
                medicaidSkilled,
                medicaidLongTerm
            });

            return `
                <div class="facility-impact-section">
                    <div class="facility-impact-title">
                        🏥 Your Facility Impact - This Bill Only
                    </div>

                    <div class="facility-impact-grid">
                        <div class="facility-impact-card">
                            <div class="facility-impact-value ${getImpactColorClass(billImpact.medicareImpact)}">
                                ${formatCurrency(billImpact.medicareImpact)}</div>
                            <div class="facility-impact-label">Medicare Revenue Impact<br><small>${medicareSkilled} beds</small></div>
                        </div>

                        <div class="facility-impact-card">
                            <div class="facility-impact-value ${getImpactColorClass(billImpact.medicaidImpact)}">
                                ${formatCurrency(billImpact.medicaidImpact)}</div>
                            <div class="facility-impact-label">Medicaid Revenue Impact<br><small>${medicaidSkilled + medicaidLongTerm} beds</small></div>
                        </div>

                        <div class="facility-impact-card">
                            <div class="facility-impact-value ${getImpactColorClass(-billImpact.staffingCost)}">
                                -$${billImpact.staffingCost.toLocaleString()}</div>
                            <div class="facility-impact-label">Additional Staffing Costs<br><small>FTE Requirements</small></div>
                        </div>

                        <div class="facility-impact-card">
                            <div class="facility-impact-value ${getImpactColorClass(-billImpact.complianceImpact)}">
                                -$${billImpact.complianceImpact.toLocaleString()}</div>
                            <div class="facility-impact-label">Additional Compliance Costs<br><small>Documentation/Training</small></div>
                        </div>

                        <div class="facility-total-card ${
                            billImpact.totalImpact > 0 ? 'facility-total-gain' :
                            billImpact.totalImpact < 0 ? 'facility-total-loss' : 'facility-total-neutral'
                        }">
                            <div class="facility-total-value">${formatCurrency(billImpact.totalImpact)}</div>
                            <div class="facility-total-label">
                                ${billImpact.totalImpact > 0 ? 'NET GAIN' :
                                  billImpact.totalImpact < 0 ? 'NET LOSS' : 'NEUTRAL IMPACT'}
                            </div>
                        </div>
                    </div>

                    <div class="per-day-impacts">
                        <div class="per-day-card">
                            <div class="per-day-value ${getImpactColorClass(billImpact.medicarePerDay)}">
                                ${formatCurrency(billImpact.medicarePerDay)}</div>
                            <div class="per-day-label">Revenue per Medicare day</div>
                        </div>

                        <div class="per-day-card">
                            <div class="per-day-value ${getImpactColorClass(billImpact.medicaidPerDay)}">
                                ${formatCurrency(billImpact.medicaidPerDay)}</div>
                            <div class="per-day-label">Revenue per Medicaid day</div>
                        </div>

                        <div class="per-day-card">
                            <div class="per-day-value ${getImpactColorClass(billImpact.totalPerDay)}">
                                ${formatCurrency(billImpact.totalPerDay)}</div>
                            <div class="per-day-label">Net impact per day</div>
                        </div>

                        <div class="per-day-card">
                            <div class="per-day-value ${getImpactColorClass(billImpact.totalPerBed)}">
                                ${formatCurrency(billImpact.totalPerBed)}</div>
                            <div class="per-day-label">Net annual impact per bed</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateBillSpecificImpact(bill, facilityData) {
            const { totalCensus, medicareSkilled, medicaidSkilled, medicaidLongTerm } = facilityData;

            // Payment rates
            const MEDICARE_RATE = 600;
            const MEDICAID_SKILLED_RATE = 250;
            const MEDICAID_LTC_RATE = 200;
            const ANNUAL_DAYS = 365;
            const ANNUAL_NURSE_SALARY = 75000;

            // Extract rate change for this bill
            const rateChange = extractRateChange(bill.title, bill.ai_explanation);

            // Calculate Medicare Impact
            let medicareImpact = 0;
            if (bill.title.includes('Medicare') || bill.ai_impact_type === 'direct') {
                medicareImpact = (rateChange / 100) * MEDICARE_RATE * medicareSkilled * ANNUAL_DAYS;
            }

            // Calculate Medicaid Impact
            let medicaidSkilledImpact = 0;
            let medicaidLTCImpact = 0;

            if (bill.title.includes('Medicare') || bill.ai_impact_type === 'direct') {
                // Indirect impact from Medicare changes
                const indirectRate = rateChange * 0.3;
                medicaidSkilledImpact = (indirectRate / 100) * MEDICAID_SKILLED_RATE * medicaidSkilled * ANNUAL_DAYS;
                medicaidLTCImpact = (indirectRate / 100) * MEDICAID_LTC_RATE * medicaidLongTerm * ANNUAL_DAYS;
            } else if (bill.title.includes('Medicaid') || bill.ai_impact_type === 'financial') {
                // Direct Medicaid impact at 80% of Medicare rate
                const medicaidRate = rateChange * 0.8;
                medicaidSkilledImpact = (medicaidRate / 100) * MEDICAID_SKILLED_RATE * medicaidSkilled * ANNUAL_DAYS;
                medicaidLTCImpact = (medicaidRate / 100) * MEDICAID_LTC_RATE * medicaidLongTerm * ANNUAL_DAYS;
            }

            const medicaidImpact = medicaidSkilledImpact + medicaidLTCImpact;

            // Calculate Staffing Impact
            let staffingCost = 0;
            if (bill.impact_breakdown.staffing.score > 0) {
                const requiredPPDIncrease = calculatePPDIncrease(bill.impact_breakdown.staffing);
                const additionalNursingHours = requiredPPDIncrease * totalCensus * ANNUAL_DAYS;
                const additionalFTEs = additionalNursingHours / 2000;
                staffingCost = additionalFTEs * ANNUAL_NURSE_SALARY;
            }

            // Calculate Compliance Impact
            let complianceImpact = 0;
            if (bill.impact_breakdown.compliance.score > 0) {
                let complianceCostPerBed = 0;
                if (bill.impact_breakdown.compliance.score >= 8) {
                    complianceCostPerBed = 2500;
                } else if (bill.impact_breakdown.compliance.score >= 5) {
                    complianceCostPerBed = 1200;
                } else {
                    complianceCostPerBed = 600;
                }
                complianceImpact = complianceCostPerBed * totalCensus;
            }

            // Calculate net impact correctly: Revenue - Costs
            const totalPayerImpact = medicareImpact + medicaidImpact;
            const revenueTotal = Math.max(0, totalPayerImpact);
            const revenueLoss = Math.abs(Math.min(0, totalPayerImpact));
            const costTotal = staffingCost + complianceImpact + revenueLoss;
            const totalImpact = revenueTotal - costTotal;

            return {
                medicareImpact,
                medicaidImpact,
                staffingCost,
                complianceImpact,
                totalImpact,
                medicarePerDay: medicareImpact / ANNUAL_DAYS,
                medicaidPerDay: medicaidImpact / ANNUAL_DAYS,
                totalPerDay: totalImpact / ANNUAL_DAYS,
                totalPerBed: totalImpact / totalCensus
            };
        }

        function getImpactColorClass(value) {
            if (value > 0) return 'impact-positive';
            if (value < 0) return 'impact-negative';
            return 'impact-neutral';
        }

        function formatCurrency(value) {
            if (value === 0) return '$0';
            const sign = value >= 0 ? '+' : '';
            return `${sign}$${Math.abs(value).toLocaleString()}`;
        }

        function createImpactCategoryCard(icon, name, impact) {
            const progressWidth = (impact.score / 10) * 100;
            const burdenClass = `burden-${impact.burden_level}`;
            const progressClass = `progress-${impact.burden_level}`;

            return `
                <div class="impact-category-card">
                    <div class="category-header">
                        <span class="category-name">${icon} ${name}</span>
                        <span class="category-score ${burdenClass}">${impact.score}/10</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${progressWidth}%"></div>
                    </div>
                    <div class="burden-level ${burdenClass}">${impact.burden_level.toUpperCase()} BURDEN</div>
                </div>
            `;
        }

        function toggleExpand(billId) {
            const expandRow = document.getElementById(`expand-${billId}`);
            const btn = document.getElementById(`btn-${billId}`);

            if (expandRow.classList.contains('expanded')) {
                expandRow.classList.remove('expanded');
                btn.classList.remove('expanded');
                btn.innerHTML = '📋';
            } else {
                expandRow.classList.add('expanded');
                btn.classList.add('expanded');
                btn.innerHTML = '🔼';
            }
        }

        function toggleCalculator() {
            const content = document.getElementById('calculatorContent');
            const toggle = document.getElementById('calculatorToggle');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = 'Hide Calculator';
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = 'Show Calculator';
            }
        }

        function calculateMyImpact() {
            // Get facility data
            const totalCensus = parseInt(document.getElementById('totalCensus').value) || 0;
            const medicareSkilled = parseInt(document.getElementById('medicareSkilled').value) || 0;
            const medicaidSkilled = parseInt(document.getElementById('medicaidSkilled').value) || 0;
            const medicaidLongTerm = parseInt(document.getElementById('medicaidLongTerm').value) || 0;
            const nursingPPD = parseFloat(document.getElementById('nursingPPD').value) || 0;
            const therapyPPD = parseFloat(document.getElementById('therapyPPD').value) || 0;

            if (totalCensus === 0) {
                alert('Please enter your total facility census to calculate impact.');
                return;
            }

            // Save facility data to localStorage for future visits
            saveFacilityData({
                totalCensus,
                medicareSkilled,
                medicaidSkilled,
                medicaidLongTerm,
                nursingPPD,
                therapyPPD,
                lastUpdated: new Date().toISOString()
            });

            const bills = dashboardData.bills;

            // Payment rates per day
            const MEDICARE_RATE = 600;
            const MEDICAID_SKILLED_RATE = 250;
            const MEDICAID_LTC_RATE = 200;
            const ANNUAL_DAYS = 365;
            const ANNUAL_NURSE_SALARY = 75000;

            // Initialize impact calculations
            let medicareImpact = 0;
            let medicaidSkilledImpact = 0;
            let medicaidLTCImpact = 0;
            let staffingCost = 0;
            let complianceImpact = 0;

            bills.forEach(bill => {
                // Extract rate changes from bill title and content
                const rateChange = extractRateChange(bill.title, bill.ai_explanation);

                // Calculate Medicare Impact: (rate change % × $600 × Medicare Census × 365)
                if (bill.title.includes('Medicare') || bill.ai_impact_type === 'direct') {
                    const medicareRateImpact = (rateChange / 100) * MEDICARE_RATE * medicareSkilled * ANNUAL_DAYS;
                    medicareImpact += medicareRateImpact;

                    // Indirect impact on Medicaid (30% of Medicare rate change)
                    const indirectRate = rateChange * 0.3;
                    medicaidSkilledImpact += (indirectRate / 100) * MEDICAID_SKILLED_RATE * medicaidSkilled * ANNUAL_DAYS;
                    medicaidLTCImpact += (indirectRate / 100) * MEDICAID_LTC_RATE * medicaidLongTerm * ANNUAL_DAYS;
                }

                // Calculate Medicaid Skilled impact: (rate change % × $250 × Medicaid Skilled Census × 365)
                if (bill.title.includes('Medicaid') || bill.ai_impact_type === 'financial') {
                    const medicaidRate = rateChange * 0.8; // Medicaid typically follows Medicare at reduced rate
                    medicaidSkilledImpact += (medicaidRate / 100) * MEDICAID_SKILLED_RATE * medicaidSkilled * ANNUAL_DAYS;
                    medicaidLTCImpact += (medicaidRate / 100) * MEDICAID_LTC_RATE * medicaidLongTerm * ANNUAL_DAYS;
                }

                // Calculate Staffing Impact
                if (bill.impact_breakdown.staffing.score > 0) {
                    const requiredPPDIncrease = calculatePPDIncrease(bill.impact_breakdown.staffing);
                    const additionalNursingHours = requiredPPDIncrease * totalCensus * ANNUAL_DAYS;
                    const additionalFTEs = additionalNursingHours / 2000; // 2000 hours per FTE per year
                    const additionalStaffingCost = additionalFTEs * ANNUAL_NURSE_SALARY;

                    staffingCost += additionalStaffingCost;
                }

                // Calculate Compliance Impact
                if (bill.impact_breakdown.compliance.score > 0) {
                    // Base compliance cost per bed based on complexity
                    let complianceCostPerBed = 0;
                    if (bill.impact_breakdown.compliance.score >= 8) {
                        complianceCostPerBed = 2500; // High complexity
                    } else if (bill.impact_breakdown.compliance.score >= 5) {
                        complianceCostPerBed = 1200; // Medium complexity
                    } else {
                        complianceCostPerBed = 600; // Low complexity
                    }
                    complianceImpact += complianceCostPerBed * totalCensus;
                }
            });

            // Calculate totals with proper revenue vs cost separation
            const totalPayerImpact = medicareImpact + medicaidSkilledImpact + medicaidLTCImpact;

            // Separate revenue (positive impacts) from costs (always positive as costs)
            const revenueTotal = Math.max(0, totalPayerImpact); // Only count positive payer impacts as revenue
            const revenueLoss = Math.abs(Math.min(0, totalPayerImpact)); // Count negative payer impacts as lost revenue
            const costTotal = staffingCost + complianceImpact + revenueLoss; // All costs including lost revenue

            // NET impact = Revenue - Costs
            const netImpact = revenueTotal - costTotal;
            const monthlyImpact = netImpact / 12;
            const perBedAnnualImpact = netImpact / totalCensus;

            // Display results with proper revenue/cost breakdown
            const netImpactClass = netImpact >= 0 ? 'positive' : 'negative';
            const netImpactColor = netImpact >= 0 ? '#28a745' : '#dc3545';
            const netImpactIcon = netImpact >= 0 ? '📈' : '📉';

            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card" style="grid-column: span 2; background: linear-gradient(135deg, ${netImpactColor}, ${netImpact >= 0 ? '#20c997' : '#e74c3c'}); color: white; border-left: none;">
                    <div class="result-value" style="font-size: 2.2rem; color: white;">${netImpact >= 0 ? 'NET GAIN: +' : 'NET LOSS: '}$${Math.abs(netImpact).toLocaleString()}</div>
                    <div class="result-label" style="color: rgba(255,255,255,0.9); font-weight: 600;">${netImpactIcon} Annual Financial Impact</div>
                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.8); margin-top: 8px; text-align: center;">
                        Revenue Changes: +$${revenueTotal.toLocaleString()} - Cost Increases: $${costTotal.toLocaleString()} = ${netImpact >= 0 ? 'Gain' : 'Loss'}: ${netImpact >= 0 ? '+' : ''}$${Math.abs(netImpact).toLocaleString()}
                    </div>
                </div>
                <div class="result-card" style="background: #e8f5e8; border-left: 4px solid #28a745;">
                    <div class="result-value" style="color: #28a745;">+$${revenueTotal.toLocaleString()}</div>
                    <div class="result-label" style="color: #2d5016;">💰 Revenue Changes<br><small>(Rate increases)</small></div>
                </div>
                <div class="result-card" style="background: #ffe6e6; border-left: 4px solid #dc3545;">
                    <div class="result-value" style="color: #dc3545;">-$${costTotal.toLocaleString()}</div>
                    <div class="result-label" style="color: #721c24;">💸 Cost Increases<br><small>(New requirements)</small></div>
                </div>
                <div class="result-card" style="background: ${netImpact >= 0 ? '#e8f5e8' : '#ffebee'}; border-left: 4px solid ${netImpact >= 0 ? '#28a745' : '#dc3545'};">
                    <div class="result-value" style="color: ${netImpact >= 0 ? '#28a745' : '#dc3545'};">${netImpact >= 0 ? '+' : ''}$${Math.abs(monthlyImpact).toLocaleString()}</div>
                    <div class="result-label" style="color: ${netImpact >= 0 ? '#2d5016' : '#721c24'};">Monthly Impact</div>
                </div>
                <div class="result-card" style="background: ${netImpact >= 0 ? '#e8f5e8' : '#ffebee'}; border-left: 4px solid ${netImpact >= 0 ? '#28a745' : '#dc3545'};">
                    <div class="result-value" style="color: ${netImpact >= 0 ? '#28a745' : '#dc3545'};">${netImpact >= 0 ? '+' : ''}$${Math.abs(perBedAnnualImpact).toFixed(0)}</div>
                    <div class="result-label" style="color: ${netImpact >= 0 ? '#2d5016' : '#721c24'};">Per Bed Annual</div>
                </div>
                <div class="result-card" style="background: ${medicareImpact >= 0 ? '#e8f5e8' : '#ffebee'}; border-left: 4px solid ${medicareImpact >= 0 ? '#28a745' : '#dc3545'};">
                    <div class="result-value" style="color: ${medicareImpact >= 0 ? '#28a745' : '#dc3545'};">${medicareImpact >= 0 ? '+' : ''}$${Math.abs(medicareImpact).toLocaleString()}</div>
                    <div class="result-label" style="color: ${medicareImpact >= 0 ? '#2d5016' : '#721c24'};">Medicare Revenue Impact<br><small>(${medicareSkilled} beds)</small></div>
                </div>
                <div class="result-card" style="background: ${medicaidSkilledImpact >= 0 ? '#e8f5e8' : '#ffebee'}; border-left: 4px solid ${medicaidSkilledImpact >= 0 ? '#28a745' : '#dc3545'};">
                    <div class="result-value" style="color: ${medicaidSkilledImpact >= 0 ? '#28a745' : '#dc3545'};">${medicaidSkilledImpact >= 0 ? '+' : ''}$${Math.abs(medicaidSkilledImpact).toLocaleString()}</div>
                    <div class="result-label" style="color: ${medicaidSkilledImpact >= 0 ? '#2d5016' : '#721c24'};">Medicaid Skilled Revenue<br><small>(${medicaidSkilled} beds)</small></div>
                </div>
                <div class="result-card" style="background: ${medicaidLTCImpact >= 0 ? '#e8f5e8' : '#ffebee'}; border-left: 4px solid ${medicaidLTCImpact >= 0 ? '#28a745' : '#dc3545'};">
                    <div class="result-value" style="color: ${medicaidLTCImpact >= 0 ? '#28a745' : '#dc3545'};">${medicaidLTCImpact >= 0 ? '+' : ''}$${Math.abs(medicaidLTCImpact).toLocaleString()}</div>
                    <div class="result-label" style="color: ${medicaidLTCImpact >= 0 ? '#2d5016' : '#721c24'};">Medicaid LTC Revenue<br><small>(${medicaidLongTerm} beds)</small></div>
                </div>
                <div class="result-card" style="background: #ffebee; border-left: 4px solid #dc3545;">
                    <div class="result-value" style="color: #dc3545;">-$${staffingCost.toLocaleString()}</div>
                    <div class="result-label" style="color: #721c24;">Additional Staffing Costs<br><small>(FTE Requirements)</small></div>
                </div>
                <div class="result-card" style="background: #ffebee; border-left: 4px solid #dc3545;">
                    <div class="result-value" style="color: #dc3545;">-$${complianceImpact.toLocaleString()}</div>
                    <div class="result-label" style="color: #721c24;">Additional Compliance Costs<br><small>(Documentation/Training)</small></div>
                </div>
            `;

            // Show results
            const resultsContainer = document.getElementById('impactResults');
            resultsContainer.classList.add('show');

            // Enable report generation button
            const reportBtn = document.getElementById('reportBtn');
            reportBtn.disabled = false;
        }

        function extractRateChange(title, explanation) {
            // Extract percentage rate changes from bill titles and explanations
            const text = `${title} ${explanation}`.toLowerCase();

            // Look for explicit rate changes
            const increasePatterns = [
                /(\d+(?:\.\d+)?)\s*%\s*(?:increase|raise|boost|higher)/,
                /increase.*?(\d+(?:\.\d+)?)\s*%/,
                /raise.*?(\d+(?:\.\d+)?)\s*%/
            ];

            const decreasePatterns = [
                /(\d+(?:\.\d+)?)\s*%\s*(?:decrease|cut|reduction|lower)/,
                /decrease.*?(\d+(?:\.\d+)?)\s*%/,
                /cut.*?(\d+(?:\.\d+)?)\s*%/
            ];

            // Check for increases
            for (const pattern of increasePatterns) {
                const match = text.match(pattern);
                if (match) {
                    return parseFloat(match[1]);
                }
            }

            // Check for decreases
            for (const pattern of decreasePatterns) {
                const match = text.match(pattern);
                if (match) {
                    return -parseFloat(match[1]);
                }
            }

            // Default estimates based on bill type and AI score
            if (text.includes('payment') || text.includes('rate')) {
                if (text.includes('increase') || text.includes('raise') || text.includes('boost')) {
                    return 2.5; // Default 2.5% increase
                } else if (text.includes('decrease') || text.includes('cut') || text.includes('reduction')) {
                    return -2.0; // Default 2% decrease
                }
                return 1.5; // Neutral adjustment
            }

            return 0; // No rate change detected
        }

        function calculatePPDIncrease(staffingBreakdown) {
            // Calculate additional PPD requirements based on staffing impact score
            const score = staffingBreakdown.score;

            if (score >= 8) {
                return 0.5; // High impact: 0.5 additional PPD
            } else if (score >= 5) {
                return 0.3; // Medium impact: 0.3 additional PPD
            } else if (score >= 2) {
                return 0.1; // Low impact: 0.1 additional PPD
            }

            return 0; // No additional PPD required
        }

        function saveFacilityData(data) {
            try {
                localStorage.setItem('snf_facility_data', JSON.stringify(data));
                console.log('Facility data saved to localStorage');
            } catch (error) {
                console.warn('Failed to save facility data to localStorage:', error);
            }
        }

        function loadFacilityData() {
            try {
                const savedData = localStorage.getItem('snf_facility_data');
                if (savedData) {
                    const data = JSON.parse(savedData);

                    // Load saved values into form fields
                    document.getElementById('totalCensus').value = data.totalCensus || 120;
                    document.getElementById('medicareSkilled').value = data.medicareSkilled || 85;
                    document.getElementById('medicaidSkilled').value = data.medicaidSkilled || 25;
                    document.getElementById('medicaidLongTerm').value = data.medicaidLongTerm || 10;
                    document.getElementById('nursingPPD').value = data.nursingPPD || 3.2;
                    document.getElementById('therapyPPD').value = data.therapyPPD || 1.8;

                    console.log('Facility data loaded from localStorage');
                    return true;
                }
            } catch (error) {
                console.warn('Failed to load facility data from localStorage:', error);
            }
            return false;
        }

        function resetCalculator() {
            document.getElementById('totalCensus').value = '120';
            document.getElementById('medicareSkilled').value = '85';
            document.getElementById('medicaidSkilled').value = '25';
            document.getElementById('medicaidLongTerm').value = '10';
            document.getElementById('nursingPPD').value = '3.2';
            document.getElementById('therapyPPD').value = '1.8';

            const resultsContainer = document.getElementById('impactResults');
            resultsContainer.classList.remove('show');

            // Disable report button
            const reportBtn = document.getElementById('reportBtn');
            reportBtn.disabled = true;
        }

        function generateFacilityReport() {
            // Initialize jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Get facility data
            const facilityData = {
                totalCensus: parseInt(document.getElementById('totalCensus').value) || 0,
                medicareSkilled: parseInt(document.getElementById('medicareSkilled').value) || 0,
                medicaidSkilled: parseInt(document.getElementById('medicaidSkilled').value) || 0,
                medicaidLongTerm: parseInt(document.getElementById('medicaidLongTerm').value) || 0,
                nursingPPD: parseFloat(document.getElementById('nursingPPD').value) || 0,
                therapyPPD: parseFloat(document.getElementById('therapyPPD').value) || 0
            };

            const reportDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            let yPos = 20;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;

            // Header
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('SNF Legislation Impact Report', margin, yPos);

            yPos += 8;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Generated: ${reportDate}`, margin, yPos);

            yPos += 15;

            // Facility Census Data Section
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Facility Census Data', margin, yPos);
            yPos += 10;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            const censusData = [
                `Total Census: ${facilityData.totalCensus} beds`,
                `Medicare Skilled: ${facilityData.medicareSkilled} beds (${((facilityData.medicareSkilled/facilityData.totalCensus)*100).toFixed(1)}%)`,
                `Medicaid Skilled: ${facilityData.medicaidSkilled} beds (${((facilityData.medicaidSkilled/facilityData.totalCensus)*100).toFixed(1)}%)`,
                `Medicaid Long-Term: ${facilityData.medicaidLongTerm} beds (${((facilityData.medicaidLongTerm/facilityData.totalCensus)*100).toFixed(1)}%)`,
                `Nursing PPD: ${facilityData.nursingPPD}`,
                `Therapy PPD: ${facilityData.therapyPPD}`
            ];

            censusData.forEach(line => {
                doc.text(`• ${line}`, margin + 5, yPos);
                yPos += 6;
            });

            yPos += 10;

            // Calculate total annual impact across all bills
            const bills = dashboardData.bills;
            let totalMedicareImpact = 0;
            let totalMedicaidImpact = 0;
            let totalStaffingCost = 0;
            let totalComplianceCost = 0;

            const billImpacts = [];

            bills.forEach(bill => {
                const impact = calculateBillSpecificImpact(bill, facilityData);
                billImpacts.push({
                    id: bill.id,
                    title: bill.title,
                    ...impact
                });

                totalMedicareImpact += impact.medicareImpact;
                totalMedicaidImpact += impact.medicaidImpact;
                totalStaffingCost += impact.staffingCost;
                totalComplianceCost += impact.complianceCost;
            });

            // Calculate net impact correctly for PDF report
            const totalPayerRevenue = totalMedicareImpact + totalMedicaidImpact;
            const revenueTotal = Math.max(0, totalPayerRevenue);
            const revenueLoss = Math.abs(Math.min(0, totalPayerRevenue));
            const costTotal = totalStaffingCost + totalComplianceCost + revenueLoss;
            const totalAnnualImpact = revenueTotal - costTotal;

            // Total Impact Summary Section
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Total Annual Impact Summary', margin, yPos);
            yPos += 10;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            const impactSummary = [
                `Revenue from Rate Changes: +${formatCurrency(revenueTotal)}`,
                `Lost Revenue: ${formatCurrency(revenueLoss)}`,
                `Staffing Costs: ${formatCurrency(totalStaffingCost)}`,
                `Compliance Costs: ${formatCurrency(totalComplianceCost)}`,
                ``,
                `Net Impact: ${totalAnnualImpact >= 0 ? '+' : ''}${formatCurrency(totalAnnualImpact)}`
            ];

            impactSummary.forEach(line => {
                doc.text(`• ${line}`, margin + 5, yPos);
                yPos += 6;
            });

            yPos += 5;
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            const impactColor = totalAnnualImpact >= 0 ? 'positive' : 'negative';
            doc.text(`Total Annual Impact: ${formatCurrency(totalAnnualImpact)}`, margin, yPos);
            yPos += 8;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.text(`Impact per bed: ${formatCurrency(totalAnnualImpact / facilityData.totalCensus)}`, margin, yPos);

            yPos += 15;

            // Bill-by-Bill Impact Analysis
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Bill Impact Analysis', margin, yPos);
            yPos += 10;

            // Sort bills by total impact
            const sortedBills = billImpacts.sort((a, b) => b.totalImpact - a.totalImpact);

            sortedBills.forEach((bill, index) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                const truncatedTitle = bill.title.length > 80 ? bill.title.substring(0, 80) + '...' : bill.title;
                doc.text(`${index + 1}. Bill ${bill.id}`, margin, yPos);
                yPos += 6;

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const titleLines = doc.splitTextToSize(truncatedTitle, pageWidth - 2 * margin);
                doc.text(titleLines, margin + 5, yPos);
                yPos += titleLines.length * 5;

                doc.setFontSize(9);
                const billDetails = [
                    `Medicare Revenue Impact: ${formatCurrency(bill.medicareImpact)}`,
                    `Medicaid Revenue Impact: ${formatCurrency(bill.medicaidImpact)}`,
                    `Additional Staffing Costs: -$${bill.staffingCost.toLocaleString()}`,
                    `Additional Compliance Costs: -$${bill.complianceCost.toLocaleString()}`,
                    `Net Impact: ${formatCurrency(bill.totalImpact)}`
                ];

                billDetails.forEach(detail => {
                    doc.text(`   • ${detail}`, margin + 10, yPos);
                    yPos += 4;
                });

                yPos += 8;
            });

            // Implementation Timeline Section
            if (yPos > 200) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Implementation Timeline', margin, yPos);
            yPos += 10;

            // Get upcoming deadlines from bills
            const upcomingDeadlines = [];
            bills.forEach(bill => {
                if (bill.comment_deadline && bill.days_until_deadline > 0) {
                    upcomingDeadlines.push({
                        title: bill.title,
                        deadline: bill.comment_deadline,
                        days: bill.days_until_deadline,
                        urgent: bill.comment_period_urgent
                    });
                }

                // Add implementation timeline if available
                if (bill.implementation_timeline) {
                    try {
                        const timeline = JSON.parse(bill.implementation_timeline);
                        timeline.forEach(milestone => {
                            if (milestone.status === 'upcoming') {
                                upcomingDeadlines.push({
                                    title: `${bill.title.substring(0, 40)}... - ${milestone.milestone}`,
                                    deadline: milestone.date,
                                    description: milestone.description,
                                    type: 'milestone'
                                });
                            }
                        });
                    } catch (e) {
                        // Skip if can't parse timeline
                    }
                }
            });

            // Sort by urgency and date
            upcomingDeadlines.sort((a, b) => {
                if (a.urgent && !b.urgent) return -1;
                if (!a.urgent && b.urgent) return 1;
                return (a.days || 365) - (b.days || 365);
            });

            upcomingDeadlines.slice(0, 10).forEach(item => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const urgentPrefix = item.urgent ? '[URGENT] ' : '';
                const daysText = item.days ? `(${item.days} days)` : '';
                doc.text(`${urgentPrefix}${item.deadline} ${daysText}`, margin, yPos);
                yPos += 5;

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                const titleLines = doc.splitTextToSize(item.title, pageWidth - 2 * margin);
                doc.text(titleLines, margin + 5, yPos);
                yPos += titleLines.length * 4 + 8;
            });

            // Facility-Specific Action Items
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text('Recommended Actions by Census Mix', margin, yPos);
            yPos += 10;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');

            // Generate recommendations based on payer mix
            const medicarePercent = (facilityData.medicareSkilled / facilityData.totalCensus) * 100;
            const medicaidPercent = ((facilityData.medicaidSkilled + facilityData.medicaidLongTerm) / facilityData.totalCensus) * 100;

            const recommendations = [];

            if (medicarePercent > 50) {
                recommendations.push('High Medicare Census (>50%):');
                recommendations.push('  • Monitor Medicare payment rule changes closely');
                recommendations.push('  • Focus on quality measures affecting Medicare star ratings');
                recommendations.push('  • Ensure PDPM documentation accuracy');
                recommendations.push('  • Track hospital readmission measures');
                recommendations.push('');
            }

            if (medicaidPercent > 60) {
                recommendations.push('High Medicaid Census (>60%):');
                recommendations.push('  • Monitor state Medicaid rate announcements');
                recommendations.push('  • Focus on cost containment strategies');
                recommendations.push('  • Ensure compliance with state-specific requirements');
                recommendations.push('  • Track staffing mandate compliance');
                recommendations.push('');
            }

            if (facilityData.nursingPPD < 3.0) {
                recommendations.push('Low Nursing PPD (<3.0):');
                recommendations.push('  • Monitor staffing mandate legislation closely');
                recommendations.push('  • Prepare for potential nursing staff increases');
                recommendations.push('  • Budget for additional nursing costs');
                recommendations.push('');
            }

            recommendations.push('General Recommendations:');
            recommendations.push('  • Review and update policies quarterly');
            recommendations.push('  • Train staff on new documentation requirements');
            recommendations.push('  • Monitor comment periods for key regulations');
            recommendations.push('  • Maintain compliance documentation systems');

            recommendations.forEach(rec => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }

                if (rec.includes(':')) {
                    doc.setFont('helvetica', 'bold');
                } else {
                    doc.setFont('helvetica', 'normal');
                }

                doc.text(rec, margin, yPos);
                yPos += 5;
            });

            // Footer
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text(`Page ${i} of ${totalPages} | Generated by SNF Legislation Tracker`,
                         margin, doc.internal.pageSize.height - 10);
            }

            // Save the PDF
            const fileName = `SNF_Legislation_Impact_Report_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }

        function getFinancialImpactClass(impact) {
            if (impact >= 2500) return 'impact-high-positive';
            if (impact >= 1500) return 'impact-medium-positive';
            if (impact > 0) return 'impact-low-positive';
            return 'impact-negative';
        }

        function getStatusClass(status) {
            if (status.includes('Published')) return 'status-published';
            if (status.includes('Comment')) return 'status-comment';
            if (status.includes('Committee')) return 'status-committee';
            if (status.includes('Passed')) return 'status-passed';
            if (status.includes('Introduced')) return 'status-introduced';
            return 'status-published';
        }

        function getRuleTypeClass(ruleType) {
            if (ruleType === 'Final Rule') return 'rule-final';
            if (ruleType === 'Proposed Rule') return 'rule-proposed';
            if (ruleType === 'Bill') return 'rule-bill';
            return 'rule-final';
        }

        function getImpactEmoji(type) {
            const emojis = {
                'direct': '🎯',
                'financial': '💰',
                'competitive': '🏆',
                'workforce': '👥'
            };
            return emojis[type] || '📋';
        }

        function formatDate(dateString) {
            if (!dateString) return 'TBD';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
</body>
</html>